<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hokkaido V7</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F2F7">
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

    <style>
        :root {
            --bg-body: #F2F2F7;
            --primary: #007AFF; 
            --accent-flight: #007AFF;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --line-color: #D1D1D6;
            
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --tab-height: calc(60px + var(--safe-bottom));
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding-bottom: calc(var(--tab-height) + 20px);
            padding-top: calc(50px + var(--safe-top)); /* é ç•™ Header é«˜åº¦ */
            user-select: none;
            overflow-x: hidden;
        }

        /* --- Header (Top Bar) --- */
        .header-wrapper {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            background: rgba(242, 242, 247, 0.95);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 10px 20px; 
            padding-top: max(10px, var(--safe-top));
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
            height: calc(50px + var(--safe-top));
        }
        .header-left { display: flex; flex-direction: column; }
        .header-title { font-size: 22px; font-weight: 800; }
        .header-subtitle { font-size: 11px; color: var(--text-sub); }
        
        /* Settings Icon (Top Right) */
        .settings-btn {
            width: 36px; height: 36px; background: #E5E5EA; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--primary); cursor: pointer; transition: transform 0.1s;
        }
        .settings-btn:active { transform: scale(0.9); }

        /* --- Timeline Styles --- */
        .timeline-container { padding: 20px 10px 80px 0; }
        .period-section { margin-bottom: 30px; }
        .period-label { font-size: 18px; font-weight: 800; color: var(--text-main); margin-bottom: 15px; padding-left: 20px; display: flex; align-items: center; }
        .period-label::before { content: ''; display: inline-block; width: 8px; height: 8px; background: var(--primary); border-radius: 50%; margin-right: 8px; }
        .timeline-item { display: flex; position: relative; margin-bottom: 20px; }
        .time-column { width: 55px; flex-shrink: 0; text-align: right; padding-right: 10px; padding-top: 12px; font-size: 13px; font-weight: 600; color: var(--text-main); font-variant-numeric: tabular-nums; }
        .time-column.no-time { color: transparent; }
        .timeline-axis { position: absolute; left: 55px; top: 0; bottom: -20px; width: 2px; background: var(--line-color); z-index: 0; }
        .timeline-dot { position: absolute; left: 50px; top: 16px; width: 12px; height: 12px; background: var(--bg-body); border: 2px solid var(--primary); border-radius: 50%; z-index: 1; }
        .card-column { flex: 1; min-width: 0; padding-right: 16px; }
        
        /* General Card */
        .card { background: #fff; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); position: relative; overflow: hidden; transition: transform 0.1s; }
        .card:active { transform: scale(0.98); }
        .card-img { width: 100%; height: 140px; object-fit: cover; display: block; }
        .card-content { padding: 12px 14px 14px; }
        .card-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; color: #000; line-height: 1.3; }
        .card-note { font-size: 13px; color: #666; background: #F2F2F7; padding: 6px 10px; border-radius: 8px; display: inline-block; margin-top: 4px; line-height: 1.4; }
        
        /* Action Buttons inside Card */
        .map-btn { position: absolute; bottom: 12px; right: 12px; width: 32px; height: 32px; background: #E5F4FF; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); cursor: pointer; }
        .map-icon { width: 18px; height: 18px; fill: currentColor; }
        .btn-delete { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; border-radius: 50%; background: rgba(0,0,0,0.1); border: none; color: #8E8E93; font-size: 14px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .card.no-img .btn-delete { background: transparent; color: #C7C7CC; top: 4px; right: 4px; }

        /* === Flight Card === */
        .flight-card { background: #fff; border-radius: 16px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); position: relative; overflow: hidden; border-left: 6px solid var(--accent-flight); }
        .flight-header { background: #F2F8FF; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; }
        .flight-no { font-weight: 800; color: var(--accent-flight); font-size: 18px; }
        .flight-date { font-size: 13px; color: #666; font-weight: 600; }
        .flight-body { padding: 16px; display: flex; align-items: center; justify-content: space-between; }
        .airport-code { font-size: 24px; font-weight: 800; color: #000; }
        .flight-arrow { color: #ccc; font-size: 20px; }
        .flight-time { font-size: 13px; color: #666; margin-top: 4px; }
        .flight-footer { padding: 10px 16px; border-top: 1px dashed #eee; display: flex; gap: 10px; }
        .ticket-btn { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #E5E5EA; background: #fff; color: var(--primary); font-size: 14px; font-weight: 600; text-align: center; }

        /* === Map Page Styles === */
        .map-hero-btn { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; border: 1px solid rgba(0,122,255,0.1); }
        .map-hero-left { display: flex; align-items: center; gap: 16px; }
        .map-hero-icon { width: 50px; height: 50px; background: #E5F4FF; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 24px; }
        .map-hero-text h3 { margin: 0 0 4px; font-size: 18px; }
        .map-hero-text p { margin: 0; color: #8E8E93; font-size: 13px; }
        .map-list-item { background: #fff; padding: 16px; border-radius: 16px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .map-list-icon { width: 40px; height: 40px; border-radius: 10px; background: #34C759; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 14px; flex-shrink: 0; }
        .map-list-icon.food { background: #FF9500; }
        .map-list-info { flex: 1; }
        .map-list-title { font-weight: 600; font-size: 16px; margin-bottom: 2px; }
        .map-list-url { font-size: 12px; color: #C7C7CC; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .map-edit-btn { padding: 8px; color: #C7C7CC; }

        /* FAB */
        .fab { position: fixed; bottom: calc(var(--safe-bottom) + 80px); right: 20px; width: 56px; height: 56px; background: #1C1C1E; border-radius: 20px; color: white; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); z-index: 999; }

        /* Tab Bar (Updated) */
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: var(--tab-height); background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 0.5px solid rgba(0,0,0,0.15); display: flex; justify-content: space-around; padding-top: 8px; z-index: 1000; padding-bottom: var(--safe-bottom); }
        .tab-item { width: 20%; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; color: #999; }
        .tab-item.active { color: var(--primary); }
        .tab-icon { width: 24px; height: 24px; fill: currentColor; }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .day-scroller { display: flex; overflow-x: auto; gap: 10px; padding: 10px 20px; scrollbar-width: none; }
        .day-chip { background: white; color: var(--text-sub); padding: 8px 16px; border-radius: 99px; font-size: 14px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.05); white-space: nowrap; }
        .day-chip.active { background: #000; color: #fff; transform: scale(1.05); }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: flex-end; }
        .modal-overlay.show { display: flex; }
        .modal-sheet { background: #fff; width: 100%; max-width: 600px; border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 24px; padding-bottom: 50px; max-height: 90vh; overflow-y: auto; }
        .form-row { display: flex; gap: 10px; margin-bottom: 16px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 14px; background: #F2F2F7; border: none; border-radius: 12px; font-size: 16px; outline: none; margin-bottom: 16px; }
        .form-textarea { height: 80px; resize: none; }
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 14px; font-size: 16px; font-weight: 600; }
        
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 3000; display: none; align-items: center; justify-content: center; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading">è™•ç†ä¸­...</div>

    <div class="header-wrapper">
        <div class="header-left">
            <div class="header-title" id="pageTitle">Hokkaido</div>
            <div class="header-subtitle" id="pageSubtitle">Day 1 â€¢ è¡Œç¨‹</div>
        </div>
        <div class="settings-btn" onclick="openAddModal('settings_menu')">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
        </div>
    </div>

    <div id="page-itinerary" class="page active">
        <div class="day-scroller" id="dayScroller"></div>
        <div class="timeline-container" id="timelineContent"></div>
        <div class="fab" onclick="openAddModal('trip')">ï¼‹</div>
    </div>

    <div id="page-mustdo" class="page">
        <div style="padding: 20px;">
            <h3 style="margin-bottom:10px;">ç´„æ³•ä¸‰ç« </h3>
            <textarea id="coupleRules" class="form-textarea" style="background:#fff; height:100px;" placeholder="è¼¸å…¥ç´„å®š..."></textarea>
            <h3 style="margin:20px 0 10px;">å¿…åšæ¸…å–®</h3>
            <div id="mustDoContainer"></div>
        </div>
        <div class="fab" onclick="openAddModal('mustdo')">ï¼‹</div>
    </div>

    <div id="page-hotels" class="page"><div style="padding:20px;" id="hotelList"></div><div class="fab" onclick="openAddModal('hotel')">ï¼‹</div></div>
    
    <div id="page-tickets" class="page">
        <div style="padding:20px;">
            <h3 style="margin: 0 0 10px; font-size:14px; color:#8E8E93; text-transform:uppercase;">âœˆï¸ èˆªç­è³‡è¨Š (PDF)</h3>
            <div id="flightList"></div>
            <h3 style="margin: 30px 0 10px; font-size:14px; color:#8E8E93; text-transform:uppercase;">ğŸŸ æ™¯é»é–€ç¥¨ & JR Pass</h3>
            <div id="ticketList"></div>
        </div>
        <div class="fab" onclick="openAddModal('ticket_choice')">ï¼‹</div>
    </div>

    <div id="page-map" class="page">
        <div style="padding: 20px;">
            <div class="map-hero-btn" onclick="openCurrentLocation()">
                <div class="map-hero-left">
                    <div class="map-hero-icon">ğŸ“</div>
                    <div class="map-hero-text"><h3>æˆ‘ç¾åœ¨åœ¨å“ªï¼Ÿ</h3><p>é–‹å•Ÿ Google Maps å®šä½</p></div>
                </div>
                <div style="color:#C7C7CC;">â€º</div>
            </div>
            <h3 style="margin: 30px 0 15px; font-size:14px; color:#8E8E93; text-transform:uppercase;">æˆ‘çš„è‡ªè¨‚åœ°åœ–</h3>
            <div id="mapListContainer"></div>
            <p style="color:#8E8E93; font-size:12px; margin-top:20px; line-height:1.5;">ğŸ’¡ é»æ“Šä¸Šæ–¹æ¸…å–®ï¼Œç›´æ¥é–‹å•Ÿ Google Maps åœ–å±¤ã€‚</p>
        </div>
    </div>

    <nav class="tab-bar">
        <div class="tab-item active" onclick="switchTab('itinerary')"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/></svg><span>è¡Œç¨‹</span></div>
        <div class="tab-item" onclick="switchTab('mustdo')"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M14 17H4v2h10v-2zm6-8H4v2h16V9zM4 15h16v-2H4v2zM4 5v2h16V5H4z"/></svg><span>æ¸…å–®</span></div>
        <div class="tab-item" onclick="switchTab('hotels')"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M7 13c1.66 0 3-1.34 3-3S8.66 7 7 7s-3 1.34-3 3 1.34 3 3 3zm12-6h-8v7H3V5H1v15h2v-3h18v3h2v-9c0-2.21-1.79-4-4-4z"/></svg><span>ä½å®¿</span></div>
        <div class="tab-item" onclick="switchTab('tickets')"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M13 13l-3-2.25L7 13V4H6v16h12V4h-1v9zM3 20h18v2H3v-2z"/></svg><span>ç¥¨åˆ¸</span></div>
        <div class="tab-item" onclick="switchTab('map')"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg><span>åœ°åœ–</span></div>
    </nav>

    <div class="modal-overlay" id="addModal" onclick="if(event.target===this) closeModal()">
        <div class="modal-sheet">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 id="modalTitle" style="margin:0;">æ–°å¢</h3>
                <span onclick="closeModal()" style="color:#999; cursor:pointer;">å–æ¶ˆ</span>
            </div>
            <div id="modalBody"></div>
            <button class="btn" id="modalSaveBtn">å„²å­˜</button>
        </div>
    </div>

    <script>
        const DAYS = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6'];
        const PERIODS = ['morning', 'afternoon', 'evening'];
        const PERIOD_LABEL = { morning: 'æ—©å®‰ Morning', afternoon: 'åˆå®‰ Afternoon', evening: 'æ™šå®‰ Evening' };
        const STORAGE_KEY = 'hokkaido_v7_final';

        let appData = { 
            activeDay: 'Day 1', mustDo: [], coupleRules: '', itinerary: {}, hotels: [], tickets: [], flights: [],
            maps: [
                { name: 'åŒ—æµ·é“æ™¯é»', url: 'https://maps.app.goo.gl/YCiJYAw3ZDBpatnp9', type: 'place' },
                { name: 'åŒ—æµ·é“ç¾é£Ÿ', url: 'https://maps.app.goo.gl/E8PcCWDnZKVuzN618', type: 'food' }
            ]
        };

        function init() {
            DAYS.forEach(d => { if(!appData.itinerary[d]) appData.itinerary[d] = { morning:[], afternoon:[], evening:[] }; });
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) { try { appData = { ...appData, ...JSON.parse(saved) }; } catch(e){} }
            
            // Init Checks
            if (!appData.flights) appData.flights = [];
            if (!appData.maps || appData.maps.length === 0) appData.maps = [
                { name: 'åŒ—æµ·é“æ™¯é»', url: 'https://maps.app.goo.gl/YCiJYAw3ZDBpatnp9', type: 'place' },
                { name: 'åŒ—æµ·é“ç¾é£Ÿ', url: 'https://maps.app.goo.gl/E8PcCWDnZKVuzN618', type: 'food' }
            ];

            renderDayScroller(); renderTimeline(); renderOthers(); renderMaps();
            
            document.getElementById('coupleRules').value = appData.coupleRules || '';
            document.getElementById('coupleRules').addEventListener('input', e => {
                appData.coupleRules = e.target.value; saveData();
            });
        }
        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }

        // --- Core Render ---
        function renderTimeline() {
            const container = document.getElementById('timelineContent'); container.innerHTML = '';
            const dayData = appData.itinerary[appData.activeDay];
            let hasItem = false;
            PERIODS.forEach(p => {
                let items = dayData[p] || [];
                items.sort((a, b) => { if (!a.hh) return 1; if (!b.hh) return -1; return (a.hh * 60 + parseInt(a.mm)) - (b.hh * 60 + parseInt(b.mm)); });
                if (items.length > 0) {
                    hasItem = true;
                    const group = document.createElement('div'); group.className = 'period-section';
                    group.innerHTML = `<div class="period-label">${PERIOD_LABEL[p]}</div>`;
                    items.forEach((item, idx) => {
                        let mapLink = item.mapUrl || (item.title ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.title)}` : '');
                        const timeDisplay = (item.hh && item.mm) ? `${item.hh}:${item.mm}` : '';
                        const imgHtml = item.image ? `<img src="${item.image}" class="card-img" loading="lazy">` : '';
                        const cardClass = item.image ? 'card' : 'card no-img';
                        group.innerHTML += `
                            <div class="timeline-item">
                                <div class="time-column ${timeDisplay ? '' : 'no-time'}">${timeDisplay || '--:--'}</div>
                                <div class="timeline-axis"></div><div class="timeline-dot"></div>
                                <div class="card-column"><div class="${cardClass}">
                                    ${imgHtml}<div class="card-content"><div class="card-title">${item.title}</div>${item.note ? `<div class="card-note">${item.note}</div>` : ''}</div>
                                    <button class="btn-delete" onclick="deleteTrip('${p}', ${idx})">âœ•</button>
                                    <div class="map-btn" onclick="openMap('${mapLink}')"><svg class="map-icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></div>
                                </div></div>
                            </div>`;
                    });
                    container.appendChild(group);
                }
            });
            if(!hasItem) container.innerHTML = `<div style="text-align:center; color:#ccc; margin-top:50px;">é‚„æ²’æœ‰è¡Œç¨‹<br>é»æ“Šå³ä¸‹è§’ ï¼‹ æ–°å¢</div>`;
        }

        function renderOthers() {
            const mc = document.getElementById('mustDoContainer'); mc.innerHTML = '';
            appData.mustDo.forEach((m, i) => mc.innerHTML += `<div style="background:#fff; padding:16px; margin-bottom:8px; border-radius:12px; display:flex;" onclick="toggleMustDo(${i})"><span style="flex:1; text-decoration:${m.done?'line-through':''}; color:${m.done?'#ccc':'#000'}">${m.text}</span><span style="color:#ccc;" onclick="event.stopPropagation(); deleteOther('mustDo', ${i})">âœ•</span></div>`);
            
            const renderSimple = (id, type) => {
                const el = document.getElementById(id); el.innerHTML = '';
                appData[type].forEach((x, i) => el.innerHTML += `<div style="background:#fff; padding:16px; border-radius:16px; margin-bottom:12px; position:relative;"><div style="font-weight:bold;">${x.name}</div><div style="color:#888; font-size:13px; margin:4px 0;">${x.date||x.time}</div>${x.file ? `<button onclick="openFile('${x.file}')" style="margin-top:8px; padding:6px 12px; border:1px solid #eee; background:#fff; color:#007AFF; border-radius:8px;">æŸ¥çœ‹æ†‘è­‰</button>` : ''}<button onclick="deleteOther('${type}', ${i})" style="position:absolute; top:16px; right:16px; border:none; background:transparent; color:#ccc;">âœ•</button></div>`);
            };
            renderSimple('hotelList', 'hotels'); renderSimple('ticketList', 'tickets');

            const fc = document.getElementById('flightList'); fc.innerHTML = '';
            appData.flights.forEach((f, i) => fc.innerHTML += `<div class="flight-card"><div class="flight-header"><span class="flight-no">âœˆ ${f.no}</span><span class="flight-date">${f.date}</span></div><div class="flight-body"><div style="text-align:center;"><div class="airport-code">${f.dep}</div><div class="flight-time">${f.depTime}</div></div><div class="flight-arrow">â</div><div style="text-align:center;"><div class="airport-code">${f.arr}</div><div class="flight-time">${f.arrTime}</div></div></div><div class="flight-footer">${f.file ? `<div class="ticket-btn" onclick="openFile('${f.file}')">é–‹å•Ÿæ©Ÿç¥¨ (PDF)</div>` : ''}<div class="ticket-btn" style="color:#FF3B30; flex:0.3;" onclick="deleteOther('flights', ${i})">âœ•</div></div></div>`);
        }

        function renderMaps() {
            const container = document.getElementById('mapListContainer'); container.innerHTML = '';
            appData.maps.forEach((m, idx) => {
                const icon = m.type === 'food' ? 'ğŸœ' : 'ğŸ—ºï¸';
                const cls = m.type === 'food' ? 'map-list-icon food' : 'map-list-icon';
                container.innerHTML += `<div class="map-list-item" onclick="openMap('${m.url}')"><div class="${cls}">${icon}</div><div class="map-list-info"><div class="map-list-title">${m.name}</div><div class="map-list-url">${m.url}</div></div><div class="map-edit-btn" onclick="event.stopPropagation(); openAddModal('edit_map', ${idx})">âœ</div></div>`;
            });
        }

        // --- Logic & Actions ---
        function switchTab(t) {
            document.querySelectorAll('.tab-item').forEach(e=>e.classList.remove('active'));
            document.querySelector(`.tab-item[onclick="switchTab('${t}')"]`).classList.add('active');
            document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
            document.getElementById(`page-${t}`).classList.add('active');
            
            const titles = { itinerary:'Hokkaido', mustdo:'Checklist', hotels:'Hotels', tickets:'Wallet', map:'Map' };
            const subs = { itinerary:`${appData.activeDay} â€¢ è¡Œç¨‹`, mustdo:'å¿…åš', hotels:'ä½å®¿', tickets:'ç¥¨åˆ¸å¤¾', map:'åœ°åœ–æŒ‡æ®ä¸­å¿ƒ' };
            document.getElementById('pageTitle').innerText = titles[t];
            document.getElementById('pageSubtitle').innerText = subs[t];
        }
        function renderDayScroller() {
            const c = document.getElementById('dayScroller'); c.innerHTML = '';
            DAYS.forEach(d => {
                const el = document.createElement('div'); el.className = `day-chip ${appData.activeDay===d?'active':''}`;
                el.innerText = d; el.onclick = () => { appData.activeDay = d; saveData(); renderDayScroller(); renderTimeline(); document.getElementById('pageSubtitle').innerText = `${d} â€¢ è¡Œç¨‹`; };
                c.appendChild(el);
            });
        }

        function deleteTrip(p, i) { if(confirm('åˆªé™¤ï¼Ÿ')) { appData.itinerary[appData.activeDay][p].splice(i,1); saveData(); renderTimeline(); }}
        function deleteOther(t, i) { if(confirm('åˆªé™¤ï¼Ÿ')) { appData[t].splice(i,1); saveData(); renderOthers(); }}
        function toggleMustDo(i) { appData.mustDo[i].done = !appData.mustDo[i].done; saveData(); renderOthers(); }
        function openMap(u) { window.open(u, '_blank'); }
        function openFile(u) { const w = window.open(); w.document.write(`<iframe src="${u}" style="width:100%;height:100%;border:0;"></iframe>`); }
        function openCurrentLocation() { window.open('https://www.google.com/maps', '_blank'); }

        // --- Helpers: Image & PDF ---
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 600; const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = (img.width > MAX_WIDTH) ? MAX_WIDTH : img.width;
                        canvas.height = (img.width > MAX_WIDTH) ? img.height * scaleSize : img.height;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height); resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                }; reader.readAsDataURL(file);
            });
        }
        function readPdf(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result); // PDF ç›´æ¥å­˜ Base64ï¼Œä¸å£“ç¸®
                reader.readAsDataURL(file);
            });
        }

        // --- Modal ---
        let currType = ''; let editIdx = -1;
        function openAddModal(type, idx = -1) {
            currType = type; editIdx = idx;
            const b = document.getElementById('modalBody'); const title = document.getElementById('modalTitle');
            const saveBtn = document.getElementById('modalSaveBtn'); saveBtn.style.display = 'block';

            if (type === 'settings_menu') {
                title.innerText = "è¨­å®š";
                b.innerHTML = `<button class="btn" onclick="exportData()" style="margin-bottom:12px; background:#fff; color:#000; border:1px solid #eee;">ğŸ“¤ åŒ¯å‡ºè¡Œç¨‹ (è¤‡è£½ä»£ç¢¼)</button><button class="btn" onclick="importData()" style="margin-bottom:12px; background:#fff; color:#000; border:1px solid #eee;">ğŸ“¥ åŒ¯å…¥è¡Œç¨‹ (è²¼ä¸Šä»£ç¢¼)</button><button class="btn" onclick="resetAllData()" style="background:#FF3B30; color:#fff;">ğŸ—‘ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button><div style="text-align:center; margin-top:20px; font-size:12px; color:#ccc;">Hokkaido App V7.0</div>`;
                saveBtn.style.display = 'none';
            } else if (type === 'ticket_choice') {
                title.innerText = "é¸æ“‡é¡å‹";
                b.innerHTML = `<button class="btn" onclick="openAddModal('flight')" style="margin-bottom:10px; background:#E5F4FF; color:#007AFF;">âœˆï¸ æ–°å¢èˆªç­</button><button class="btn" onclick="openAddModal('ticket')" style="background:#F2F2F7; color:#000;">ğŸŸ æ–°å¢é–€ç¥¨ / äº¤é€šç¥¨</button>`;
                saveBtn.style.display = 'none';
            } else if (type === 'edit_map') {
                title.innerText = "ç·¨è¼¯åœ°åœ–";
                const m = appData.maps[idx];
                b.innerHTML = `<input id="inpTitle" class="form-input" value="${m.name}" placeholder="åœ°åœ–åç¨±"><input id="inpMap" class="form-input" value="${m.url}" placeholder="URL">`;
            } else if (type === 'trip') {
                title.innerText = "æ–°å¢è¡Œç¨‹";
                let hOpts = '<option value="">-æ™‚-</option>'; for(let i=6;i<=23;i++) hOpts+=`<option value="${i.toString().padStart(2,'0')}">${i}</option>`;
                b.innerHTML = `<select id="inpPeriod" class="form-select"><option value="morning">Morning</option><option value="afternoon">Afternoon</option><option value="evening">Evening</option></select><div class="form-row"><select id="inpHH" class="form-select">${hOpts}</select><select id="inpMM" class="form-select"><option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option></select></div><input id="inpTitle" class="form-input" placeholder="æ™¯é»åç¨± *"><input id="inpMap" class="form-input" placeholder="Map é€£çµ (é¸å¡«)"><div style="font-size:14px;color:#666;margin-bottom:6px;">å°é¢ç…§ç‰‡ (é¸å¡«)</div><input id="inpImg" type="file" accept="image/*" class="form-input"><textarea id="inpNote" class="form-textarea" placeholder="å‚™è¨»..."></textarea>`;
            } else if (type === 'flight') {
                title.innerText = "æ–°å¢èˆªç­";
                b.innerHTML = `<input id="inpNo" class="form-input" placeholder="èˆªç­ä»£è™Ÿ (JX801)"><input id="inpDate" class="form-input" placeholder="æ—¥æœŸ (2/14)"><div class="form-row"><input id="inpDep" class="form-input" placeholder="å‡ºç™¼ (TPE)"><input id="inpDepTime" class="form-input" placeholder="æ™‚é–“ (10:00)"></div><div class="form-row"><input id="inpArr" class="form-input" placeholder="æŠµé” (CTS)"><input id="inpArrTime" class="form-input" placeholder="æ™‚é–“ (15:00)"></div><div style="font-size:14px;color:#666;margin-bottom:6px;">ä¸Šå‚³é›»å­æ©Ÿç¥¨ (PDF)</div><input id="inpFile" type="file" accept="application/pdf" class="form-input">`;
            } else { 
                title.innerText = "æ–°å¢";
                b.innerHTML = type === 'mustdo' ? `<input id="inpTitle" class="form-input" placeholder="äº‹é …">` : `<input id="inpTitle" class="form-input" placeholder="åç¨±"><input id="inpTime" class="form-input" placeholder="æ™‚é–“/æ—¥æœŸ"><input id="inpFile" type="file" class="form-input">`; 
            }
            document.getElementById('addModal').classList.add('show');
        }
        function closeModal() { document.getElementById('addModal').classList.remove('show'); }

        document.getElementById('modalSaveBtn').onclick = async () => {
            const loading = document.getElementById('loading'); loading.style.display = 'flex';
            if (currType === 'edit_map') {
                appData.maps[editIdx].name = document.getElementById('inpTitle').value;
                appData.maps[editIdx].url = document.getElementById('inpMap').value;
                renderMaps();
            } else if(currType === 'trip') {
                const title = document.getElementById('inpTitle').value;
                if(!title) { alert('è«‹è¼¸å…¥åç¨±'); loading.style.display='none'; return; }
                let imgData = null; const imgInput = document.getElementById('inpImg');
                if(imgInput && imgInput.files[0]) imgData = await compressImage(imgInput.files[0]);
                appData.itinerary[appData.activeDay][document.getElementById('inpPeriod').value].push({
                    title, hh: document.getElementById('inpHH').value, mm: document.getElementById('inpMM').value,
                    mapUrl: document.getElementById('inpMap').value, note: document.getElementById('inpNote').value, image: imgData
                }); renderTimeline();
            } else if (currType === 'flight') {
                const no = document.getElementById('inpNo').value;
                if(!no) { alert('è«‹è¼¸å…¥èˆªç­ä»£è™Ÿ'); loading.style.display='none'; return; }
                let fData = null; const fInput = document.getElementById('inpFile');
                if(fInput && fInput.files[0]) fData = await readPdf(fInput.files[0]); // ä½¿ç”¨ PDF è®€å–é‚è¼¯
                appData.flights.push({
                    no, date: document.getElementById('inpDate').value,
                    dep: document.getElementById('inpDep').value, depTime: document.getElementById('inpDepTime').value,
                    arr: document.getElementById('inpArr').value, arrTime: document.getElementById('inpArrTime').value, file: fData
                }); renderOthers();
            } else if(currType === 'mustdo') {
                appData.mustDo.push({text:document.getElementById('inpTitle').value, done:false}); renderOthers();
            } else {
                let fData = null; const fInput = document.getElementById('inpFile');
                if(fInput && fInput.files[0]) fData = await compressImage(fInput.files[0]);
                appData[currType+'s'].push({name:document.getElementById('inpTitle').value, [currType==='hotel'?'date':'time']:document.getElementById('inpTime').value, file:fData});
                renderOthers();
            }
            saveData(); loading.style.display = 'none'; closeModal();
        };

        function exportData() { navigator.clipboard.writeText(JSON.stringify(appData)); alert('å·²è¤‡è£½è³‡æ–™ä»£ç¢¼'); }
        function importData() { const c = prompt('è²¼ä¸Šä»£ç¢¼'); if(c) { try { appData = JSON.parse(c); saveData(); location.reload(); } catch(e){ alert('éŒ¯èª¤'); } } }
        function resetAllData() { if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }

        init();
    </script>
</body>
</html>