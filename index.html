<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hokkaido Trip</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F2F7">
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

    <style>
        :root {
            --bg-body: #F2F2F7;
            --bg-card: #FFFFFF;
            --primary: #007AFF;
            --primary-active: #0063ce;
            --destructive: #FF3B30;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --divider: #E5E5EA;
            
            --radius-l: 22px;
            --radius-m: 16px;
            
            /* iPhone å®‰å…¨å€åŸŸ */
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --tab-height: calc(60px + var(--safe-bottom));
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding-bottom: calc(var(--tab-height) + 20px);
            padding-top: var(--safe-top);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            user-select: none; /* ç¦æ­¢é¸å–æ–‡å­—ï¼Œåƒ App */
        }

        /* --- é»æ“Šç‰©ç†å›é¥‹ (Micro-interaction) --- */
        .clickable:active {
            transform: scale(0.96);
            transition: transform 0.1s ease;
        }

        /* --- Header --- */
        .header-wrapper {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(242, 242, 247, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 10px 20px 10px;
            border-bottom: 0.5px solid rgba(0,0,0,0.05);
        }
        
        .header-title {
            font-size: 30px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            font-size: 13px;
            color: var(--text-sub);
            font-weight: 500;
            margin-top: 2px;
        }

        .section-title {
            font-size: 13px;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin: 24px 20px 8px;
        }

        /* --- Cards --- */
        .card {
            background: var(--bg-card);
            margin: 0 16px 12px;
            padding: 16px;
            border-radius: var(--radius-m);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            position: relative;
            transition: all 0.2s ease;
        }

        /* --- Buttons --- */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.25);
        }
        .btn:active { background: var(--primary-active); }
        
        .btn-text {
            background: transparent;
            border: none;
            color: var(--primary);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }

        /* --- Tab Bar --- */
        .tab-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: var(--tab-height);
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding-top: 8px;
            z-index: 100;
            padding-bottom: var(--safe-bottom);
        }

        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: #999;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            width: 20%;
            transition: color 0.2s;
        }

        .tab-item.active { color: var(--primary); }
        .tab-icon { width: 26px; height: 26px; fill: currentColor; }

        /* --- Pages & Transitions --- */
        .page { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.2s, transform 0.2s; }
        .page.active { display: block; opacity: 1; transform: translateY(0); }

        /* --- Day Scroller --- */
        .day-scroller {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 5px 20px 15px;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .day-scroller::-webkit-scrollbar { display: none; }

        .day-chip {
            background: white;
            color: var(--text-sub);
            padding: 8px 18px;
            border-radius: 99px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(0,0,0,0.03);
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .day-chip.active {
            background: var(--text-main); /* ç”¨é»‘è‰²æ›´æœ‰è³ªæ„Ÿï¼Œæˆ–ç¶­æŒè—è‰² */
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: scale(1.05);
        }

        /* --- Itinerary List --- */
        .period-group { margin-bottom: 24px; }
        .period-header {
            display: flex;
            align-items: center;
            margin: 0 20px 10px;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-sub);
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .trip-card {
            display: flex;
            gap: 14px;
            align-items: flex-start;
        }
        .trip-img {
            width: 64px; height: 64px;
            border-radius: 12px;
            background-color: #F2F2F7;
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
        }
        .trip-content { flex: 1; min-width: 0; }
        .trip-title { font-size: 17px; font-weight: 600; margin-bottom: 4px; color: var(--text-main); }
        .trip-meta { font-size: 13px; color: var(--text-sub); display: flex; align-items: center; gap: 6px; }
        .trip-note { 
            font-size: 13px; 
            color: #666; 
            margin-top: 6px; 
            background: #F9F9F9;
            padding: 6px 10px;
            border-radius: 8px;
            display: inline-block;
        }
        
        .btn-delete {
            position: absolute;
            top: 12px; right: 12px;
            background: #E5E5EA;
            border: none;
            border-radius: 50%;
            width: 24px; height: 24px;
            color: #8E8E93;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
        }

        /* --- Empty State --- */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-sub);
        }
        .empty-icon {
            width: 80px; height: 80px;
            margin-bottom: 16px;
            opacity: 0.3;
            fill: currentColor;
        }

        /* --- FAB & Toast --- */
        .fab {
            position: fixed;
            bottom: calc(var(--tab-height) + 24px);
            right: 20px;
            width: 56px; height: 56px;
            background: var(--text-main); /* é»‘è‰² FAB æ›´æœ‰è¨­è¨ˆæ„Ÿ */
            border-radius: 20px;
            color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            z-index: 90;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }

        .toast {
            position: fixed;
            top: 20px; left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 99px;
            font-size: 14px;
            font-weight: 600;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 300;
            display: flex; align-items: center; gap: 8px;
        }
        .toast.show {
            transform: translateX(-50%) translateY(calc(var(--safe-top) + 10px));
            opacity: 1;
        }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: flex-end;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        
        .modal-sheet {
            background: #fff;
            width: 100%;
            max-width: 600px;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 24px 20px 40px;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-overlay.show .modal-sheet { transform: translateY(0); }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 16px;
            background: #F2F2F7;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            margin-bottom: 16px;
            color: var(--text-main);
            outline: none;
        }
        .form-input:focus { background: #E5E5EA; }
        .form-textarea { height: 100px; resize: none; }

        /* --- Must Do List --- */
        .mustdo-row {
            display: flex;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--divider);
        }
        .mustdo-row:last-child { border-bottom: none; }
        .checkbox {
            width: 24px; height: 24px;
            border-radius: 50%;
            border: 2px solid #C7C7CC;
            margin-right: 14px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .checkbox.checked {
            background: var(--primary);
            border-color: var(--primary);
        }
        .checkbox.checked::after { content: 'âœ“'; color: #fff; font-size: 14px; font-weight: 800; }
        .mustdo-text { font-size: 16px; transition: color 0.2s; }
        .mustdo-text.done { color: #C7C7CC; text-decoration: line-through; }

    </style>
</head>
<body>

    <div class="header-wrapper">
        <div class="header-title" id="pageTitle">Hokkaido</div>
        <div class="header-subtitle" id="pageSubtitle">Day 1 â€¢ æœ­å¹Œå¸‚å€</div>
    </div>

    <div class="toast" id="toast">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        <span id="toastMsg">å·²å„²å­˜</span>
    </div>

    <div id="page-itinerary" class="page active">
        <div class="day-scroller" id="dayScroller">
            </div>

        <div id="itineraryContent" style="padding-bottom: 80px;">
            </div>
        
        <div class="fab clickable" onclick="openAddModal('trip')">ï¼‹</div>
    </div>

    <div id="page-mustdo" class="page">
        <div class="section-title">æˆ‘å€‘çš„ç´„å®š</div>
        <div class="card">
            <textarea id="coupleRules" class="form-textarea" style="background:transparent; padding:0; height:80px; margin:0;" placeholder="è¼¸å…¥ä½ å€‘çš„ç´„æ³•ä¸‰ç« ..."></textarea>
        </div>

        <div class="section-title">å¿…åšæ¸…å–®</div>
        <div class="card" id="mustDoContainer">
            </div>
        <div style="padding: 0 16px;">
            <button class="btn clickable" style="background:#E5E5EA; color:#000;" onclick="openAddModal('mustdo')">ï¼‹ æ–°å¢é …ç›®</button>
        </div>
    </div>

    <div id="page-hotels" class="page">
        <div class="section-title">ä½å®¿è³‡è¨Š</div>
        <div id="hotelList"></div>
        <div class="fab clickable" onclick="openAddModal('hotel')">ï¼‹</div>
    </div>

    <div id="page-tickets" class="page">
        <div class="section-title">é›»å­ç¥¨åˆ¸ & æ–‡ä»¶</div>
        <div id="ticketList"></div>
        <div class="fab clickable" onclick="openAddModal('ticket')">ï¼‹</div>
    </div>

    <div id="page-settings" class="page">
        <div class="section-title">è³‡æ–™å‚™ä»½</div>
        <div class="card clickable" onclick="exportData()" style="display:flex; justify-content:space-between; align-items:center;">
            <span>ğŸ“¤ åŒ¯å‡ºè¡Œç¨‹ (è¤‡è£½ä»£ç¢¼)</span>
            <span style="color:#C7C7CC">â€º</span>
        </div>
        <div class="card clickable" onclick="importData()" style="display:flex; justify-content:space-between; align-items:center;">
            <span>ğŸ“¥ åŒ¯å…¥è¡Œç¨‹ (è²¼ä¸Šä»£ç¢¼)</span>
            <span style="color:#C7C7CC">â€º</span>
        </div>
        
        <div class="section-title">é‡ç½®</div>
        <div class="card clickable" onclick="resetAllData()" style="color:var(--destructive); display:flex; justify-content:space-between; align-items:center;">
            <span>ğŸ—‘ åˆªé™¤æ‰€æœ‰è³‡æ–™</span>
        </div>
        
        <div style="text-align:center; color:#C7C7CC; font-size:12px; margin-top:30px;">
            Designed for You<br>Hokkaido Trip V2.0
        </div>
    </div>

    <nav class="tab-bar">
        <div class="tab-item active clickable" onclick="switchTab('itinerary')">
            <svg class="tab-icon" viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
            <span>è¡Œç¨‹</span>
        </div>
        <div class="tab-item clickable" onclick="switchTab('mustdo')">
            <svg class="tab-icon" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
            <span>æ¸…å–®</span>
        </div>
        <div class="tab-item clickable" onclick="switchTab('hotels')">
            <svg class="tab-icon" viewBox="0 0 24 24"><path d="M7 13c1.66 0 3-1.34 3-3S8.66 7 7 7s-3 1.34-3 3 1.34 3 3 3zm12-6h-8v7H3V5H1v15h2v-3h18v3h2v-9c0-2.21-1.79-4-4-4z"/></svg>
            <span>ä½å®¿</span>
        </div>
        <div class="tab-item clickable" onclick="switchTab('tickets')">
            <svg class="tab-icon" viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/></svg>
            <span>ç¥¨åˆ¸</span>
        </div>
        <div class="tab-item clickable" onclick="switchTab('settings')">
            <svg class="tab-icon" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            <span>è¨­å®š</span>
        </div>
    </nav>

    <div class="modal-overlay" id="addModal" onclick="if(event.target===this) closeModal()">
        <div class="modal-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 id="modalTitle" style="margin:0; font-size:20px;">æ–°å¢</h3>
                <button class="btn-text clickable" style="font-weight:600; color:#C7C7CC;" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
            <div id="modalBody"></div>
            <button class="btn clickable" id="modalSaveBtn" style="margin-top:20px;">å„²å­˜</button>
        </div>
    </div>

    <script>
        const DAYS = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6'];
        const PERIODS = ['morning', 'afternoon', 'evening'];
        const STORAGE_KEY = 'hokkaido_v2_pro';

        let appData = {
            activeDay: 'Day 1',
            mustDo: [
                { id: 1, text: 'åœ¨æ–°åƒæ­²æ©Ÿå ´åƒæ‹‰éºµ', done: false },
                { id: 2, text: 'å’Œç”·å‹åœ¨é›ªåœ°åˆç…§', done: false }
            ],
            coupleRules: '',
            itinerary: {},
            hotels: [],
            tickets: []
        };

        // --- Init ---
        function init() {
            DAYS.forEach(day => {
                if (!appData.itinerary[day]) appData.itinerary[day] = { morning: [], afternoon: [], evening: [] };
            });

            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try { appData = { ...appData, ...JSON.parse(saved) }; } catch(e) {}
            }

            renderDayScroller();
            renderItinerary();
            renderMustDo();
            renderHotels();
            renderTickets();
            
            document.getElementById('coupleRules').value = appData.coupleRules || '';
            document.getElementById('coupleRules').addEventListener('input', (e) => {
                appData.coupleRules = e.target.value;
                saveData();
            });
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        // --- Navigation ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab-item[onclick="switchTab('${tab}')"]`).classList.add('active');
            
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${tab}`).classList.add('active');

            const titles = { itinerary: 'Hokkaido', mustdo: 'Checklist', hotels: 'Hotels', tickets: 'Wallet', settings: 'Settings' };
            const subs = { itinerary: `${appData.activeDay} â€¢ è¡Œç¨‹`, mustdo: 'å¿…åšæ¸…å–® & ç´„å®š', hotels: 'ä½å®¿æ†‘è­‰', tickets: 'ç¥¨åˆ¸ç®¡ç†', settings: 'ç³»çµ±è¨­å®š' };
            
            document.getElementById('pageTitle').innerText = titles[tab];
            document.getElementById('pageSubtitle').innerText = subs[tab];
        }

        // --- Itinerary ---
        function renderDayScroller() {
            const c = document.getElementById('dayScroller');
            c.innerHTML = '';
            DAYS.forEach(day => {
                const d = document.createElement('div');
                d.className = `day-chip clickable ${appData.activeDay === day ? 'active' : ''}`;
                d.innerText = day;
                d.onclick = () => {
                    appData.activeDay = day;
                    saveData();
                    renderDayScroller();
                    renderItinerary();
                    document.getElementById('pageSubtitle').innerText = `${day} â€¢ è¡Œç¨‹`;
                };
                c.appendChild(d);
            });
        }

        function renderItinerary() {
            const container = document.getElementById('itineraryContent');
            container.innerHTML = '';
            const dayData = appData.itinerary[appData.activeDay];

            const pMap = { morning: 'æ—©ä¸Š', afternoon: 'ä¸‹åˆ', evening: 'æ™šä¸Š' };

            PERIODS.forEach(p => {
                const group = document.createElement('div');
                group.className = 'period-group';
                group.innerHTML = `<div class="period-header">${pMap[p]}</div>`;
                
                const list = document.createElement('div');
                list.className = 'period-list';
                
                if (dayData[p].length === 0) {
                    list.innerHTML = `
                        <div style="margin:0 20px; padding:15px; border:1px dashed #E5E5EA; border-radius:16px; color:#C7C7CC; font-size:14px; text-align:center;">
                           + æ–°å¢è¡Œç¨‹
                        </div>`;
                    list.onclick = () => openAddModal('trip');
                } else {
                    dayData[p].forEach((item, idx) => {
                        const card = document.createElement('div');
                        card.className = 'card trip-card clickable';
                        card.innerHTML = `
                            <img src="${item.image || 'https://via.placeholder.com/100?text=IMG'}" class="trip-img">
                            <div class="trip-content">
                                <div class="trip-title">${item.title}</div>
                                <div class="trip-meta">
                                    <span style="background:#F2F2F7; padding:2px 6px; border-radius:4px; font-weight:600; font-size:11px;">${item.time || 'æœªå®š'}</span>
                                    ${item.mapUrl ? '<span>ğŸ“ Map</span>' : ''}
                                </div>
                                ${item.note ? `<div class="trip-note">${item.note}</div>` : ''}
                            </div>
                            <button class="btn-delete clickable" onclick="event.stopPropagation(); deleteItem('itinerary', '${p}', ${idx})">âœ•</button>
                        `;
                        // é»æ“Šå¡ç‰‡é–‹å•Ÿ Map
                        if(item.mapUrl) {
                            card.onclick = () => window.open(item.mapUrl);
                        }
                        list.appendChild(card);
                    });
                }
                group.appendChild(list);
                container.appendChild(group);

                new Sortable(list, { group: 'shared', animation: 150, ghostClass: 'sortable-ghost' });
            });
        }

        // --- Must Do ---
        function renderMustDo() {
            const c = document.getElementById('mustDoContainer');
            c.innerHTML = '';
            if(appData.mustDo.length === 0) {
                c.innerHTML = `<div class="empty-state">å°šæœªæ–°å¢ä»»ä½•é …ç›®</div>`;
                return;
            }
            appData.mustDo.forEach((item, idx) => {
                const row = document.createElement('div');
                row.className = 'mustdo-row clickable';
                row.innerHTML = `
                    <div class="checkbox ${item.done ? 'checked' : ''}"></div>
                    <div class="mustdo-text ${item.done ? 'done' : ''}" style="flex:1;">${item.text}</div>
                    <button class="btn-text" style="color:#C7C7CC;" onclick="event.stopPropagation(); deleteItem('mustdo', null, ${idx})">âœ•</button>
                `;
                row.onclick = () => {
                    item.done = !item.done;
                    saveData();
                    renderMustDo();
                };
                c.appendChild(row);
            });
        }

        // --- Hotels & Tickets ---
        function renderHotels() {
            const c = document.getElementById('hotelList');
            c.innerHTML = '';
            if(appData.hotels.length === 0) {
                c.innerHTML = getEmptyStateHTML('å°šç„¡ä½å®¿è³‡æ–™');
                return;
            }
            appData.hotels.forEach((h, idx) => {
                const card = document.createElement('div');
                card.className = 'card clickable';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span style="font-weight:700; font-size:18px;">${h.name}</span>
                        <button class="btn-delete clickable" onclick="deleteItem('hotels', null, ${idx})">âœ•</button>
                    </div>
                    <div style="color:#8E8E93; font-size:14px; margin-bottom:12px;">ğŸ“… ${h.date}</div>
                    ${h.file ? `<button class="btn" style="height:40px; font-size:14px; background:#F2F2F7; color:var(--primary);" onclick="openFile('${h.file}')">ğŸ“„ æŸ¥çœ‹æ†‘è­‰</button>` : ''}
                `;
                c.appendChild(card);
            });
        }

        function renderTickets() {
            const c = document.getElementById('ticketList');
            c.innerHTML = '';
            if(appData.tickets.length === 0) {
                c.innerHTML = getEmptyStateHTML('å°šç„¡ç¥¨åˆ¸');
                return;
            }
            appData.tickets.forEach((t, idx) => {
                const card = document.createElement('div');
                card.className = 'card clickable';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span style="font-weight:700; font-size:18px;">${t.name}</span>
                        <button class="btn-delete clickable" onclick="deleteItem('tickets', null, ${idx})">âœ•</button>
                    </div>
                    <div style="color:#8E8E93; font-size:14px; margin-bottom:12px;">ğŸ•’ ${t.time}</div>
                    ${t.file ? `<button class="btn" style="height:40px; font-size:14px; background:#E5F4FF; color:var(--primary);" onclick="openFile('${t.file}')">ğŸŸ é–‹å•Ÿç¥¨åˆ¸</button>` : ''}
                `;
                c.appendChild(card);
            });
        }

        function getEmptyStateHTML(text) {
            return `
                <div class="empty-state">
                    <svg class="empty-icon" viewBox="0 0 24 24"><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4.86 8.86l-3 3.87L9 13.14 6 17h12l-3.86-5.14z"/></svg>
                    <div>${text}</div>
                </div>
            `;
        }

        // --- Core Actions ---
        function deleteItem(type, p, idx) {
            // ä¸ä½¿ç”¨ confirm, ç›´æ¥åˆªé™¤ä½†æä¾› undo (é€™è£¡ç°¡åŒ–ç‚ºç›´æ¥åˆªé™¤+Toast)
            // æ›´åƒ App çš„åšæ³•é€šå¸¸æ˜¯ Swipe to deleteï¼Œä½†é€™è£¡ç”¨ç°¡å–®çš„é»æ“Š
            if (type === 'itinerary') appData.itinerary[appData.activeDay][p].splice(idx, 1);
            else if (type === 'mustdo') appData.mustDo.splice(idx, 1);
            else appData[type].splice(idx, 1);
            
            saveData();
            refreshAll();
            showToast('å·²åˆªé™¤');
        }

        function refreshAll() {
            renderItinerary();
            renderMustDo();
            renderHotels();
            renderTickets();
        }

        // --- Modal ---
        let currType = '';
        function openAddModal(type) {
            currType = type;
            const titles = { trip: 'æ–°å¢è¡Œç¨‹', mustdo: 'æ–°å¢å¿…åš', hotel: 'æ–°å¢ä½å®¿', ticket: 'æ–°å¢ç¥¨åˆ¸' };
            document.getElementById('modalTitle').innerText = titles[type];
            
            let html = '';
            if (type === 'trip') {
                html = `
                    <select id="inpPeriod" class="form-select">
                        <option value="morning">æ—©ä¸Š</option>
                        <option value="afternoon">ä¸‹åˆ</option>
                        <option value="evening">æ™šä¸Š</option>
                    </select>
                    <input id="inpTitle" class="form-input" placeholder="æ™¯é»åç¨± (ä¾‹: å°æ¨½é‹æ²³)">
                    <input id="inpTime" class="form-input" type="time">
                    <input id="inpMap" class="form-input" placeholder="Google Maps é€£çµ (é¸å¡«)">
                    <textarea id="inpNote" class="form-textarea" placeholder="å‚™è¨» (å¿…åƒã€äº¤é€š...)"></textarea>
                `;
            } else if (type === 'mustdo') {
                html = `<input id="inpTitle" class="form-input" placeholder="äº‹é …åç¨±">`;
            } else {
                html = `
                    <input id="inpTitle" class="form-input" placeholder="åç¨±">
                    <input id="inpTime" class="form-input" placeholder="${type==='hotel'?'æ—¥æœŸ (2/14)':'æ™‚é–“ (10:00)'}">
                    <div style="margin-bottom:10px; font-size:14px; color:#888;">ä¸Šå‚³é™„ä»¶ (åœ–ç‰‡/PDF)</div>
                    <input id="inpFile" type="file" class="form-input">
                `;
            }
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('addModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('addModal').classList.remove('show');
        }

        document.getElementById('modalSaveBtn').onclick = async () => {
            const title = document.getElementById('inpTitle').value;
            if(!title) return;

            let fileData = null;
            const fInput = document.getElementById('inpFile');
            if(fInput && fInput.files[0]) {
                const reader = new FileReader();
                fileData = await new Promise(r => {
                    reader.onload = e => r(e.target.result);
                    reader.readAsDataURL(fInput.files[0]);
                });
            }

            if(currType === 'trip') {
                appData.itinerary[appData.activeDay][document.getElementById('inpPeriod').value].push({
                    title, time: document.getElementById('inpTime').value,
                    mapUrl: document.getElementById('inpMap').value,
                    note: document.getElementById('inpNote').value
                });
            } else if (currType === 'mustdo') {
                appData.mustDo.push({ id: Date.now(), text: title, done: false });
            } else {
                appData[currType+'s'].push({
                    name: title,
                    [currType==='hotel'?'date':'time']: document.getElementById('inpTime').value,
                    file: fileData
                });
            }
            
            saveData();
            refreshAll();
            closeModal();
            showToast('æ–°å¢æˆåŠŸ');
        };

        function openFile(url) {
            const win = window.open();
            win.document.write(`<iframe src="${url}" style="border:0; width:100%; height:100%;"></iframe>`);
        }

        function resetAllData() {
            if(confirm('è­¦å‘Šï¼šç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
        
        function exportData() {
            navigator.clipboard.writeText(JSON.stringify(appData));
            showToast('ä»£ç¢¼å·²è¤‡è£½');
        }
        
        function importData() {
            const code = prompt('è«‹è²¼ä¸Šä»£ç¢¼');
            if(code) {
                try {
                    appData = JSON.parse(code);
                    saveData();
                    refreshAll();
                    showToast('åŒ¯å…¥æˆåŠŸ');
                } catch(e) { alert('æ ¼å¼éŒ¯èª¤'); }
            }
        }

        init();
    </script>
</body>
</html>