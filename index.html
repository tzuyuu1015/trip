<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>åŒ—æµ·é“è¡Œç¨‹çœ‹æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #f2f2f7;
      --surface: #ffffff;
      --accent: #0a84ff;
      --accent-soft: #e5f1ff;
      --text-main: #111827;
      --text-sub: #6b7280;
      --border: #e5e7eb;
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 12px;
      --shadow-soft: 0 6px 16px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .app {
      max-width: 980px;
      margin: 0 auto;
      padding: 12px 12px 90px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    header h1 {
      font-size: 20px;
      margin: 0;
    }

    header p {
      margin: 0;
      font-size: 12px;
      color: var(--text-sub);
      line-height: 1.5;
    }

    .toolbar {
      margin-top: 6px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .toolbar-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #374151;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s ease, transform 0.15s ease;
    }

    .toolbar-btn span {
      font-size: 14px;
    }

    .toolbar-btn:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
    }

    /* Board layoutï¼šç°¡åŒ–é™°å½±ï¼Œæ‰‹æ©Ÿå„ªå…ˆ */
    .board-wrapper {
      background: transparent;
      padding: 4px 0 8px;
    }

    .board-wrapper.flash-success {
      animation: flashSuccess 0.7s ease-out;
    }

    @keyframes flashSuccess {
      0% {
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
      }
      30% {
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.4);
      }
      100% {
        box-shadow: none;
      }
    }

    .board {
      display: flex;
      gap: 10px;
      min-height: 220px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .day-column {
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 8px;
      min-width: 230px;
      max-width: 240px;
      display: flex;
      flex-direction: column;
      max-height: 520px;
      border: 1px solid #e5e7eb;
    }

    .day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .day-title {
      font-weight: 600;
      font-size: 13px;
    }

    .day-date {
      font-size: 10px;
      color: var(--text-sub);
    }

    .period-group {
      background: #f9fafb;
      border-radius: 12px;
      padding: 5px 5px 4px;
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      min-height: 64px;
    }

    .period-header {
      font-size: 10px;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .period-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
    }

    .period-dot.morning {
      background: #f97316;
    }
    .period-dot.afternoon {
      background: #22c55e;
    }
    .period-dot.evening {
      background: #6366f1;
    }

    .card-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 1px;
    }

    .card {
      background: #f3f4f6;
      border-radius: var(--radius-sm);
      padding: 6px;
      margin-bottom: 6px;
      display: flex;
      gap: 6px;
      position: relative;
      flex-direction: row;
      align-items: flex-start;
      cursor: grab;
      opacity: 0;
      transform: translateY(4px);
      animation: fadeInCard 0.22s ease-out forwards;
      border: 1px solid #e5e7eb;
    }

    @keyframes fadeInCard {
      to {
        opacity: 1;
        transform: translateY(0px);
      }
    }

    .card img {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      background: #e5e7eb;
    }

    .card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .card-title-row {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      align-items: baseline;
    }

    .card-title {
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-time {
      font-size: 10px;
      color: var(--accent);
      flex-shrink: 0;
    }

    .card-note {
      font-size: 10px;
      color: var(--text-sub);
      max-height: 3.8em;
      overflow: hidden;
    }

    .card-footer {
      margin-top: 3px;
      display: flex;
      justify-content: flex-start;
      gap: 6px;
      align-items: center;
    }

    .map-link-btn {
      border-radius: 999px;
      border: 1px solid #bfdbfe;
      background: #e0f2fe;
      color: #075985;
      font-size: 10px;
      padding: 3px 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.15s ease, transform 0.15s ease;
    }

    .map-link-btn span {
      font-size: 13px;
    }

    .map-link-btn:hover {
      background: #bae6fd;
      transform: translateY(-1px);
    }

    .card-delete {
      position: absolute;
      right: 3px;
      top: 1px;
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 13px;
      cursor: pointer;
      padding: 2px;
      transition: color 0.15s ease, transform 0.15s ease;
    }

    .card-delete:hover {
      color: #ef4444;
      transform: scale(1.05);
    }

    .add-btn {
      margin-top: 6px;
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 6px 0;
      font-size: 12px;
      background: #e0ecff;
      color: #1d4ed8;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.15s ease;
    }

    .add-btn:hover {
      background: #c7ddff;
      transform: translateY(-1px);
    }

    /* SortableJS drag style */
    .card-chosen {
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.25) !important;
      transform: scale(1.02);
      cursor: grabbing;
    }
    .card-ghost {
      opacity: 0.45;
    }

    /* Modal */
    .modal-backdrop,
    .modal-backdrop-io {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
      z-index: 20;
    }

    .modal-backdrop.show,
    .modal-backdrop-io.show {
      display: flex;
    }

    .modal {
      background: var(--surface);
      border-radius: 18px;
      padding: 14px;
      width: 100%;
      max-width: 440px;
      box-shadow: var(--shadow-soft);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h2 {
      font-size: 16px;
      margin: 0;
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      color: var(--text-sub);
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 12px;
    }

    .field label {
      color: var(--text-sub);
    }

    .field input,
    .field textarea,
    .field select {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      font-size: 13px;
      font-family: inherit;
    }

    .field textarea {
      min-height: 60px;
      resize: vertical;
    }

    .field small {
      font-size: 11px;
      color: var(--text-sub);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .io-textarea {
      width: 100%;
      min-height: 140px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px;
    }

    .tips {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.5;
    }

    .io-helper {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 6px;
    }

    /* Toast */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(10px);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      color: #f9fafb;
      background: rgba(15, 23, 42, 0.92);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;
      z-index: 40;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0px);
    }

    .toast--success {
      background: #16a34a;
    }

    .toast-icon {
      font-size: 16px;
    }

    /* ä¸‹æ–¹ï¼šæ©Ÿç¥¨ & é£¯åº—è³‡è¨Šå€å¡Š */
    .info-panel {
      margin-top: 10px;
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 10px;
      border: 1px solid #e5e7eb;
    }

    .info-panel-title {
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 6px;
    }

    .info-panel-desc {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 6px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 10px;
    }

    .info-card {
      border-radius: 14px;
      padding: 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .info-card h3 {
      margin: 0 0 6px;
      font-size: 13px;
    }

    .info-textarea {
      width: 100%;
      min-height: 70px;
      resize: vertical;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      font-size: 12px;
      font-family: inherit;
    }

    .info-field {
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }

    .info-field label {
      color: var(--text-sub);
    }

    .info-field input[type="file"] {
      font-size: 11px;
    }

    .pdf-status {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .link-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 11px;
      padding: 3px 8px;
      cursor: pointer;
      text-decoration: none;
      color: #111827;
    }

    .link-btn:hover {
      background: #e5e7eb;
    }

    @media (min-width: 720px) {
      .info-grid {
        grid-template-columns: 1.1fr 0.9fr;
      }
    }

    /* Mobile tweaks */
    @media (max-width: 768px) {
      .app {
        padding: 10px 10px 90px;
      }

      .board {
        min-width: 100%;
      }

      .day-column {
        min-width: 76vw;
        max-width: 80vw;
      }

      header h1 {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>åŒ—æµ·é“è¡Œç¨‹çœ‹æ¿</h1>
      <p>Day1ï½Day6 è¡Œç¨‹ï¼Œå°å¡ç‰‡æ•´ç†æ™¯é»ï¼›æœ€ä¸‹æ–¹å¯è¨˜éŒ„æ©Ÿç¥¨èˆ‡ä½å®¿è³‡è¨Šï¼Œæ–¹ä¾¿æ‰‹æ©Ÿéš¨æ™‚æŸ¥çœ‹ã€‚</p>

      <div class="toolbar">
        <button class="toolbar-btn" id="exportBtn" type="button">
          <span>â¬†ï¸</span> åŒ¯å‡ºè¡Œç¨‹
        </button>
        <button class="toolbar-btn" id="importBtn" type="button">
          <span>â¬‡ï¸</span> åŒ¯å…¥è¡Œç¨‹
        </button>
      </div>
    </header>

    <div class="board-wrapper" id="boardWrapper">
      <div class="board" id="board">
        <!-- JS ç”¢ç”Ÿ Day 1~Day 6 -->
      </div>
    </div>

    <!-- ä¸‹æ–¹ï¼šæ©Ÿç¥¨ PDF & ä½å®¿è³‡è¨Š -->
    <section class="info-panel">
      <h2 class="info-panel-title">æ—…ç¨‹é‡è¦è³‡è¨Š</h2>
      <p class="info-panel-desc">
        å»ºè­°å…ˆæŠŠå»ç¨‹ / å›ç¨‹ç­æ©Ÿã€è¡Œæé¡åº¦èˆ‡å„æ™šä½å®¿åç¨±æ”¾åœ¨é€™è£¡ï¼Œå‡ºé–€åªè¦æ‰“é–‹é€™ä¸€é å°±èƒ½å¿«é€Ÿç¢ºèªã€‚
      </p>

      <div class="info-grid">
        <section class="info-card">
          <h3>âœˆï¸ æ©Ÿç¥¨è³‡è¨Š</h3>

          <textarea
            id="flightInfoTextarea"
            class="info-textarea"
            placeholder="ä¾‹å¦‚ï¼š&#10;å»ç¨‹ï¼š2/3 æ¡ƒåœ’ TPE â†’ æ–°åƒæ­² CTSï¼Œ09:30 èµ·é£›ï¼Œè¡Œæ 23kg&#10;å›ç¨‹ï¼š2/8 æ–°åƒæ­² CTS â†’ æ¡ƒåœ’ TPEï¼Œ20:15 èµ·é£›ï¼Œè¡Œæ 23kg"
          ></textarea>

          <div class="info-field">
            <label for="ticketPdfInput">æ©Ÿç¥¨ PDF æª”æ¡ˆï¼ˆé¸å¡«ï¼‰</label>
            <input id="ticketPdfInput" type="file" accept="application/pdf" />
            <div class="pdf-status" id="ticketPdfStatus">
              å°šæœªä¸Šå‚³æ©Ÿç¥¨ PDF
            </div>
          </div>
        </section>

        <section class="info-card">
          <h3>ğŸ¨ ä½å®¿è³‡è¨Š</h3>
          <textarea
            id="hotelInfoTextarea"
            class="info-textarea"
            placeholder="ä¾‹å¦‚ï¼š&#10;Day1ï¼šæœ­å¹Œ â—‹â—‹ é£¯åº—ï¼ˆè¿‘å¤§é€šç«™ 3 è™Ÿå‡ºå£ï¼‰&#10;Day2ï¼šå°æ¨½ â—‹â—‹ æ—…é¤¨ï¼ˆå«æ—©é¤ï¼‰&#10;Day3ï¼šæ´çˆºæ¹– â—‹â—‹ æº«æ³‰é£¯åº—ï¼ˆ19:00 æ™šé¤ï¼‰"
          ></textarea>
        </section>
      </div>
    </section>

    <div class="tips">
      âœ… æ¯å°è£ç½®å„è‡ªä¿å­˜ä¸€ä»½è¡Œç¨‹èˆ‡æ©Ÿç¥¨ / ä½å®¿è³‡è¨Šï¼ˆlocalStorageï¼‰<br />
      âœ… æƒ³å¾é›»è…¦æ¬åˆ°æ‰‹æ©Ÿï¼šé›»è…¦æŒ‰ã€ŒåŒ¯å‡ºè¡Œç¨‹ã€è¤‡è£½æ–‡å­— â†’ å‚³åˆ°æ‰‹æ©Ÿ â†’ æ‰‹æ©ŸæŒ‰ã€ŒåŒ¯å…¥è¡Œç¨‹ã€è²¼ä¸Š â†’ å¥—ç”¨<br />
      âœ… Map æ¬„ä½ä¸å¡«æ™‚ï¼Œæœƒç”¨ã€Œæ™¯é»åç¨±ã€ç•¶ä½œ Google Maps æœå°‹é—œéµå­—
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <span class="toast-icon">âœ”</span>
    <span id="toastMessage">å·²å®Œæˆ</span>
  </div>

  <!-- æ–°å¢æ™¯é» Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>æ–°å¢æ™¯é»</h2>
        <button class="modal-close" id="modalCloseBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label for="daySelect">å“ªä¸€å¤©</label>
          <select id="daySelect"></select>
        </div>

        <div class="field">
          <label for="periodSelect">æ™‚é–“æ®µ</label>
          <select id="periodSelect">
            <option value="morning">æ—©ä¸Š</option>
            <option value="afternoon">ä¸‹åˆ</option>
            <option value="evening">æ™šä¸Š</option>
          </select>
        </div>

        <div class="field">
          <label for="titleInput">æ™¯é» / æ´»å‹•åç¨± *</label>
          <input
            id="titleInput"
            type="text"
            placeholder="ä¾‹å¦‚ï¼šå°æ¨½é‹æ²³ã€æœ­å¹Œé›»è¦–å¡”"
          />
        </div>
        <div class="field">
          <label for="timeInput">æ™‚é–“ï¼ˆé¸å¡«ï¼‰</label>
          <input id="timeInput" type="text" placeholder="ä¾‹å¦‚ï¼š09:30ã€ä¸‹åˆ" />
        </div>
        <div class="field">
          <label for="noteInput">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
          <textarea
            id="noteInput"
            placeholder="è¦åƒçš„åº—ã€äº¤é€šæ–¹å¼ã€å°æé†’..."
          ></textarea>
        </div>
        <div class="field">
          <label for="mapInput">Map åœ°å€ / é—œéµå­—æˆ–ç¶²å€ï¼ˆé¸å¡«ï¼‰</label>
          <input
            id="mapInput"
            type="text"
            placeholder="ä¸å¡«å‰‡ç”¨æ™¯é»åç¨±æœå°‹ï¼›ä¹Ÿå¯ç›´æ¥è²¼ Google Maps é€£çµ"
          />
          <small>ä¾‹å¦‚ï¼šã€Œæœ­å¹Œé›»è¦–å¡”ã€ã€ã€Œå°æ¨½é‹æ²³ã€ã€ã€ŒåŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®å€â€¦ã€æˆ–è²¼æ•´å€‹ Google Maps URLã€‚</small>
        </div>
        <div class="field">
          <label for="imageFileInput">ä¸Šå‚³ç…§ç‰‡ï¼ˆé¸å¡«ï¼‰</label>
          <input id="imageFileInput" type="file" accept="image/*" />
          <small>ç…§ç‰‡æœƒå­˜åœ¨ç€è¦½å™¨ï¼ˆä¸æœƒä¸Šå‚³åˆ°ä¼ºæœå™¨ï¼‰ã€‚</small>
        </div>
        <div class="field">
          <label for="imageUrlInput">æˆ–åœ–ç‰‡ç¶²å€ï¼ˆé¸å¡«ï¼‰</label>
          <input
            id="imageUrlInput"
            type="url"
            placeholder="IG / Google ç›¸ç°¿ / ç¶²è·¯ç…§ç‰‡é€£çµ"
          />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelBtn">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="saveBtn" disabled>å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- åŒ¯å‡º / åŒ¯å…¥ Modal -->
  <div class="modal-backdrop-io" id="ioBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h2 id="ioTitle">åŒ¯å‡ºè¡Œç¨‹</h2>
        <button class="modal-close" id="ioCloseBtn">&times;</button>
      </div>
      <div class="modal-body" id="ioBody">
        <!-- JS ä¾æ¨¡å¼å¡«å…¥å…§å®¹ -->
      </div>
      <div class="modal-footer" id="ioFooter">
        <!-- JS ä¾æ¨¡å¼å¡«å…¥æŒ‰éˆ• -->
      </div>
    </div>
  </div>

  <!-- SortableJS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <script>
    // --- åŸºæœ¬è¨­å®š ---
    const DAYS = ["Day 1", "Day 2", "Day 3", "Day 4", "Day 5", "Day 6"];
    const PERIODS = ["morning", "afternoon", "evening"];
    const PERIOD_LABELS = {
      morning: "æ—©ä¸Š",
      afternoon: "ä¸‹åˆ",
      evening: "æ™šä¸Š",
    };

    const STORAGE_KEY = "hokkaidoTripBoard_v4";
    const META_KEY = "hokkaidoTripMeta_v1";
    const LEGACY_KEYS = ["hokkaidoTripBoard_v3"];

    const boardEl = document.getElementById("board");
    const boardWrapperEl = document.getElementById("boardWrapper");

    // æ–°å¢æ™¯é» modal å…ƒä»¶
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalCloseBtn = document.getElementById("modalCloseBtn");
    const daySelect = document.getElementById("daySelect");
    const periodSelect = document.getElementById("periodSelect");
    const titleInput = document.getElementById("titleInput");
    const timeInput = document.getElementById("timeInput");
    const noteInput = document.getElementById("noteInput");
    const mapInput = document.getElementById("mapInput");
    const imageFileInput = document.getElementById("imageFileInput");
    const imageUrlInput = document.getElementById("imageUrlInput");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");

    // åŒ¯å‡º / åŒ¯å…¥ modal å…ƒä»¶
    const ioBackdrop = document.getElementById("ioBackdrop");
    const ioTitle = document.getElementById("ioTitle");
    const ioBody = document.getElementById("ioBody");
    const ioFooter = document.getElementById("ioFooter");
    const ioCloseBtn = document.getElementById("ioCloseBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");

    // Toast
    const toastEl = document.getElementById("toast");
    const toastMessageEl = document.getElementById("toastMessage");
    let toastTimer = null;

    // åº•éƒ¨è³‡è¨Š
    const flightInfoTextarea = document.getElementById("flightInfoTextarea");
    const hotelInfoTextarea = document.getElementById("hotelInfoTextarea");
    const ticketPdfInput = document.getElementById("ticketPdfInput");
    const ticketPdfStatus = document.getElementById("ticketPdfStatus");

    let state = {}; // { "Day 1": { morning:[card], afternoon:[card], evening:[card] }, ... }
    let meta = {
      flightInfo: "",
      hotelInfo: "",
      ticketPdf: null, // { name, dataUrl }
    };

    let currentDayForAdd = "Day 1";
    let sortableInstances = [];

    // --- å·¥å…·å‡½å¼ ---
    function createEmptyState() {
      const obj = {};
      DAYS.forEach((day) => {
        obj[day] = { morning: [], afternoon: [], evening: [] };
      });
      return obj;
    }

    function createCardId() {
      return (
        "c_" +
        Date.now().toString(36) +
        Math.random().toString(36).slice(2, 8)
      );
    }

    function showToast(message, type = "success") {
      toastMessageEl.textContent = message;
      toastEl.classList.remove("toast--success");
      if (type === "success") {
        toastEl.classList.add("toast--success");
      }
      toastEl.classList.add("show");

      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        toastEl.classList.remove("show");
      }, 1800);
    }

    // --- åˆå§‹åŒ– ---
    function init() {
      // Day é¸å–®
      DAYS.forEach((day) => {
        const option = document.createElement("option");
        option.value = day;
        option.textContent = day;
        daySelect.appendChild(option);
      });

      // å¾ localStorage è¼‰å…¥è¡Œç¨‹
      let raw = window.localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        for (const k of LEGACY_KEYS) {
          const legacy = window.localStorage.getItem(k);
          if (legacy) {
            raw = legacy;
            break;
          }
        }
      }
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          state = normalizeState(parsed);
        } catch {
          state = createEmptyState();
        }
      } else {
        state = createEmptyState();
      }

      // è¼‰å…¥ meta
      const metaRaw = window.localStorage.getItem(META_KEY);
      if (metaRaw) {
        try {
          const parsedMeta = JSON.parse(metaRaw);
          meta = {
            flightInfo: parsedMeta.flightInfo || "",
            hotelInfo: parsedMeta.hotelInfo || "",
            ticketPdf: parsedMeta.ticketPdf || null,
          };
        } catch {
          meta = { flightInfo: "", hotelInfo: "", ticketPdf: null };
        }
      }

      renderBoard();
      initInfoPanel();
      bindEvents();
    }

    // è®“å„ç¨®èˆŠæ ¼å¼éƒ½èƒ½è½‰æˆ {day:{morning:[],afternoon:[],evening:[]}}
    function normalizeState(rawObj) {
      const obj = createEmptyState();
      if (typeof rawObj !== "object" || rawObj === null) return obj;

      DAYS.forEach((day) => {
        const val = rawObj[day];
        if (!val) return;

        // èˆŠç‰ˆï¼š { "Day 1": [cards...] }
        if (Array.isArray(val)) {
          obj[day].morning = val.map((item) =>
            normalizeCard(item, "morning")
          );
        }
        // æ–°ç‰ˆï¼š { "Day 1": { morning:[...], afternoon:[...], evening:[...] } }
        else if (typeof val === "object") {
          PERIODS.forEach((p) => {
            const arr = val[p];
            if (Array.isArray(arr)) {
              obj[day][p] = arr.map((item) => normalizeCard(item, p));
            }
          });
        }
      });

      return obj;
    }

    function normalizeCard(item, defaultPeriod) {
      const safe = item || {};
      return {
        id: safe.id || createCardId(),
        title: (safe.title || "").toString(),
        time: (safe.time || "").toString(),
        note: (safe.note || "").toString(),
        mapQuery: (safe.mapQuery || "").toString(),
        imageUrl: (safe.imageUrl || "").toString(),
        period: safe.period || defaultPeriod,
      };
    }

    // --- ç•«é¢æ¸²æŸ“ ---
    function renderBoard() {
      boardEl.innerHTML = "";
      destroySortables();

      DAYS.forEach((day) => {
        const column = document.createElement("section");
        column.className = "day-column";
        column.dataset.day = day;

        const header = document.createElement("div");
        header.className = "day-header";
        const title = document.createElement("div");
        title.className = "day-title";
        title.textContent = day;
        const date = document.createElement("div");
        date.className = "day-date";
        date.textContent = "";
        header.appendChild(title);
        header.appendChild(date);
        column.appendChild(header);

        PERIODS.forEach((period) => {
          const group = document.createElement("div");
          group.className = "period-group";

          const headerRow = document.createElement("div");
          headerRow.className = "period-header";

          const dot = document.createElement("div");
          dot.className = `period-dot ${period}`;
          headerRow.appendChild(dot);

          const label = document.createElement("span");
          label.textContent = PERIOD_LABELS[period];
          headerRow.appendChild(label);

          group.appendChild(headerRow);

          const cardList = document.createElement("div");
          cardList.className = "card-list";
          cardList.dataset.day = day;
          cardList.dataset.period = period;

          const cards = (state[day] && state[day][period]) || [];
          cards.forEach((card) => {
            const cardEl = createCardElement(card, day, period);
            cardList.appendChild(cardEl);
          });

          group.appendChild(cardList);
          column.appendChild(group);
        });

        const addBtn = document.createElement("button");
        addBtn.className = "add-btn";
        addBtn.type = "button";
        addBtn.textContent = "ï¼‹ æ–°å¢æ™¯é»";
        addBtn.addEventListener("click", () => openAddModal(day));
        column.appendChild(addBtn);

        boardEl.appendChild(column);
      });

      setupSortables();
    }

    function createCardElement(card, day, period) {
      const cardEl = document.createElement("div");
      cardEl.className = "card";
      cardEl.dataset.day = day;
      cardEl.dataset.period = period;
      cardEl.dataset.id = card.id;

      if (card.imageUrl) {
        const img = document.createElement("img");
        img.src = card.imageUrl;
        img.alt = card.title || "ç…§ç‰‡";
        cardEl.appendChild(img);
      }

      const content = document.createElement("div");
      content.className = "card-content";

      const titleRow = document.createElement("div");
      titleRow.className = "card-title-row";

      const title = document.createElement("div");
      title.className = "card-title";
      title.textContent = card.title || "";

      const time = document.createElement("div");
      time.className = "card-time";
      time.textContent = card.time || "";

      titleRow.appendChild(title);
      titleRow.appendChild(time);

      const note = document.createElement("div");
      note.className = "card-note";
      note.textContent = card.note || "";

      content.appendChild(titleRow);
      content.appendChild(note);

      const mapUrl = buildMapUrl(card);
      if (mapUrl) {
        const footer = document.createElement("div");
        footer.className = "card-footer";

        const mapLink = document.createElement("a");
        mapLink.href = mapUrl;
        mapLink.target = "_blank";
        mapLink.rel = "noopener noreferrer";
        mapLink.className = "map-link-btn";
        mapLink.innerHTML = '<span>ğŸ“</span> åœ¨ Google åœ°åœ–é–‹å•Ÿ';

        footer.appendChild(mapLink);
        content.appendChild(footer);
      }

      const delBtn = document.createElement("button");
      delBtn.className = "card-delete";
      delBtn.type = "button";
      delBtn.innerHTML = "&times;";
      delBtn.addEventListener("click", () => deleteCardById(card.id));

      cardEl.appendChild(content);
      cardEl.appendChild(delBtn);
      return cardEl;
    }

    function buildMapUrl(card) {
      const raw = (card.mapQuery || "").trim();
      const fallbackQuery = (card.title || "").trim();

      let query = raw || fallbackQuery;
      if (!query) return "";

      if (query.startsWith("http://") || query.startsWith("https://")) {
        return query;
      }

      const encoded = encodeURIComponent(query);
      return `https://www.google.com/maps/search/?api=1&query=${encoded}`;
    }

    // --- SortableJS ---
    function setupSortables() {
      document.querySelectorAll(".card-list").forEach((listEl) => {
        const sortable = new Sortable(listEl, {
          group: "trip-cards",
          animation: 150,
          ghostClass: "card-ghost",
          chosenClass: "card-chosen",
          dragClass: "card-drag",
          handle: ".card",
          onEnd: () => {
            syncStateFromDOM();
            persistState();
          },
        });
        sortableInstances.push(sortable);
      });
    }

    function destroySortables() {
      sortableInstances.forEach((inst) => inst.destroy());
      sortableInstances = [];
    }

    function syncStateFromDOM() {
      const newState = createEmptyState();
      const cardMap = buildCardMap();

      document.querySelectorAll(".card-list").forEach((listEl) => {
        const day = listEl.dataset.day;
        const period = listEl.dataset.period;
        if (!day || !period) return;

        const arr = [];
        listEl.querySelectorAll(".card").forEach((cardEl) => {
          const id = cardEl.dataset.id;
          const data = cardMap[id];
          if (data) {
            arr.push(data);
          }
        });
        newState[day][period] = arr;
      });

      state = newState;
    }

    function buildCardMap() {
      const map = {};
      DAYS.forEach((day) => {
        PERIODS.forEach((p) => {
          (state[day][p] || []).forEach((card) => {
            map[card.id] = card;
          });
        });
      });
      return map;
    }

    // --- ä¸‹æ–¹è³‡è¨Š UI åˆå§‹åŒ– ---
    function initInfoPanel() {
      flightInfoTextarea.value = meta.flightInfo || "";
      hotelInfoTextarea.value = meta.hotelInfo || "";
      renderTicketStatus();
    }

    function renderTicketStatus() {
      if (meta.ticketPdf && meta.ticketPdf.name) {
        ticketPdfStatus.innerHTML = "";
        const span = document.createElement("span");
        span.textContent = `å·²ä¸Šå‚³ï¼š${meta.ticketPdf.name}`;

        const openBtn = document.createElement("button");
        openBtn.type = "button";
        openBtn.className = "link-btn";
        openBtn.textContent = "é–‹å•Ÿæ©Ÿç¥¨ PDF";
        openBtn.addEventListener("click", () => {
          if (!meta.ticketPdf || !meta.ticketPdf.dataUrl) return;
          const win = window.open();
          if (win) {
            win.document.write(
              `<iframe src="${meta.ticketPdf.dataUrl}" ` +
                'style="border:0;width:100%;height:100%;"></iframe>'
            );
          }
        });

        ticketPdfStatus.appendChild(span);
        ticketPdfStatus.appendChild(openBtn);
      } else {
        ticketPdfStatus.textContent = "å°šæœªä¸Šå‚³æ©Ÿç¥¨ PDF";
      }
    }

    // --- Modal æ§åˆ¶ ---
    function openAddModal(day) {
      currentDayForAdd = day;
      daySelect.value = day;
      periodSelect.value = "morning";
      titleInput.value = "";
      timeInput.value = "";
      noteInput.value = "";
      mapInput.value = "";
      imageFileInput.value = "";
      imageUrlInput.value = "";
      saveBtn.disabled = true;
      modalBackdrop.classList.add("show");
      titleInput.focus();
    }

    function closeAddModal() {
      modalBackdrop.classList.remove("show");
    }

    function openExportModal() {
      ioTitle.textContent = "åŒ¯å‡ºè¡Œç¨‹";
      ioBody.innerHTML = "";
      ioFooter.innerHTML = "";

      const textarea = document.createElement("textarea");
      textarea.className = "io-textarea";
      textarea.id = "exportTextarea";
      textarea.value = JSON.stringify({ state, meta });

      const helper = document.createElement("div");
      helper.className = "io-helper";
      helper.textContent =
        "æ­¥é©Ÿï¼š1ï¼‰æŒ‰ã€Œå…¨é¸ä¸¦è¤‡è£½ã€ï¼Œæˆ–è‡ªå·±å…¨é¸è¤‡è£½ 2ï¼‰è²¼åˆ° LINE/Notion å‚³åˆ°æ‰‹æ©Ÿ 3ï¼‰åœ¨æ‰‹æ©Ÿé é¢æŒ‰ã€ŒåŒ¯å…¥è¡Œç¨‹ã€è²¼ä¸Šã€‚";

      ioBody.appendChild(textarea);
      ioBody.appendChild(helper);

      const closeBtn = document.createElement("button");
      closeBtn.className = "btn btn-secondary";
      closeBtn.textContent = "é—œé–‰";
      closeBtn.type = "button";
      closeBtn.addEventListener("click", closeIoModal);

      const copyBtn = document.createElement("button");
      copyBtn.className = "btn btn-primary";
      copyBtn.textContent = "å…¨é¸ä¸¦è¤‡è£½";
      copyBtn.type = "button";
      copyBtn.addEventListener("click", () => {
        textarea.focus();
        textarea.select();
        try {
          document.execCommand("copy");
          copyBtn.textContent = "å·²è¤‡è£½";
          showToast("å·²è¤‡è£½è¡Œç¨‹æ–‡å­—");
          setTimeout(() => {
            copyBtn.textContent = "å…¨é¸ä¸¦è¤‡è£½";
          }, 1500);
        } catch {
          alert("è¤‡è£½å¤±æ•—ï¼Œå¯ä»¥æ‰‹å‹•é•·æŒ‰é¸å–å…§å®¹å¾Œè¤‡è£½ã€‚");
        }
      });

      ioFooter.appendChild(closeBtn);
      ioFooter.appendChild(copyBtn);

      ioBackdrop.classList.add("show");
      textarea.focus();
      textarea.select();
    }

    function openImportModal() {
      ioTitle.textContent = "åŒ¯å…¥è¡Œç¨‹";
      ioBody.innerHTML = "";
      ioFooter.innerHTML = "";

      const textarea = document.createElement("textarea");
      textarea.className = "io-textarea";
      textarea.id = "importTextarea";
      textarea.placeholder =
        "è«‹è²¼ä¸Šå¾ã€ŒåŒ¯å‡ºè¡Œç¨‹ã€è¤‡è£½çš„é‚£æ®µæ–‡å­—ï¼ˆJSONï¼‰ã€‚\nè²¼å¥½å¾ŒæŒ‰ã€Œå¥—ç”¨è¡Œç¨‹ã€ã€‚";

      const helper = document.createElement("div");
      helper.className = "io-helper";
      helper.textContent =
        "æ³¨æ„ï¼šåŒ¯å…¥å¾Œæœƒè¦†è“‹ç›®å‰é€™å°è£ç½®ä¸Šçš„è¡Œç¨‹èˆ‡æ©Ÿç¥¨ / ä½å®¿è³‡æ–™ã€‚";

      ioBody.appendChild(textarea);
      ioBody.appendChild(helper);

      const cancelBtn = document.createElement("button");
      cancelBtn.className = "btn btn-secondary";
      cancelBtn.textContent = "å–æ¶ˆ";
      cancelBtn.type = "button";
      cancelBtn.addEventListener("click", closeIoModal);

      const applyBtn = document.createElement("button");
      applyBtn.className = "btn btn-primary";
      applyBtn.textContent = "å¥—ç”¨è¡Œç¨‹";
      applyBtn.type = "button";
      applyBtn.addEventListener("click", () => {
        const text = textarea.value.trim();
        if (!text) {
          alert("è«‹å…ˆè²¼ä¸ŠåŒ¯å‡ºçš„æ–‡å­—ã€‚");
          return;
        }

        try {
          const parsed = JSON.parse(text);
          if (parsed.state) {
            state = normalizeState(parsed.state);
          } else {
            state = normalizeState(parsed);
          }

          if (parsed.meta) {
            meta = {
              flightInfo: parsed.meta.flightInfo || "",
              hotelInfo: parsed.meta.hotelInfo || "",
              ticketPdf: parsed.meta.ticketPdf || null,
            };
          }

          persistState();
          persistMeta();
          renderBoard();
          initInfoPanel();
          closeIoModal();
          boardWrapperEl.classList.add("flash-success");
          setTimeout(
            () => boardWrapperEl.classList.remove("flash-success"),
            800
          );
          showToast("è¡Œç¨‹å·²æ›´æ–°");
        } catch (e) {
          alert(
            "åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼ä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œæˆ–å…§å®¹çµæ§‹ä¸æ­£ç¢ºã€‚è«‹ç¢ºèªè²¼ä¸Šçš„æ˜¯åŸæœ¬åŒ¯å‡ºçš„æ–‡å­—ã€‚"
          );
        }
      });

      ioFooter.appendChild(cancelBtn);
      ioFooter.appendChild(applyBtn);

      ioBackdrop.classList.add("show");
      textarea.focus();
    }

    function closeIoModal() {
      ioBackdrop.classList.remove("show");
    }

    // --- äº‹ä»¶ç¶å®š ---
    function bindEvents() {
      // æ–°å¢æ™¯é» modal
      modalCloseBtn.addEventListener("click", closeAddModal);
      cancelBtn.addEventListener("click", closeAddModal);

      modalBackdrop.addEventListener("click", (e) => {
        if (e.target === modalBackdrop) {
          closeAddModal();
        }
      });

      titleInput.addEventListener("input", () => {
        saveBtn.disabled = titleInput.value.trim() === "";
      });

      saveBtn.addEventListener("click", handleSaveCard);

      // åŒ¯å‡º / åŒ¯å…¥ modal
      ioCloseBtn.addEventListener("click", closeIoModal);
      ioBackdrop.addEventListener("click", (e) => {
        if (e.target === ioBackdrop) {
          closeIoModal();
        }
      });

      exportBtn.addEventListener("click", openExportModal);
      importBtn.addEventListener("click", openImportModal);

      // åº•éƒ¨è³‡è¨Š
      flightInfoTextarea.addEventListener("input", () => {
        meta.flightInfo = flightInfoTextarea.value;
        persistMeta();
      });

      hotelInfoTextarea.addEventListener("input", () => {
        meta.hotelInfo = hotelInfoTextarea.value;
        persistMeta();
      });

      ticketPdfInput.addEventListener("change", handleTicketUpload);
    }

    function handleSaveCard() {
      const title = titleInput.value.trim();
      if (!title) return;

      const day = daySelect.value || currentDayForAdd;
      const period = periodSelect.value || "morning";

      const baseData = {
        id: createCardId(),
        title,
        time: timeInput.value.trim(),
        note: noteInput.value.trim(),
        mapQuery: mapInput.value.trim(),
        imageUrl: "",
        period,
      };

      const file = imageFileInput.files[0];
      const url = imageUrlInput.value.trim();

      saveBtn.disabled = true;

      const finalize = (img) => {
        baseData.imageUrl = img || url || "";
        if (!state[day]) {
          state[day] = { morning: [], afternoon: [], evening: [] };
        }
        if (!state[day][period]) state[day][period] = [];
        state[day][period].push(baseData);
        persistState();
        renderBoard();
        closeAddModal();
        showToast("å·²åŠ å…¥æ™¯é»");
        saveBtn.disabled = false;
      };

      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => finalize(e.target.result);
        reader.onerror = () => finalize(url);
        reader.readAsDataURL(file);
      } else {
        finalize(url);
      }
    }

    // æ©Ÿç¥¨ PDF ä¸Šå‚³è™•ç†
    function handleTicketUpload() {
      const file = ticketPdfInput.files[0];
      if (!file) return;
      if (file.type !== "application/pdf") {
        alert("è«‹é¸æ“‡ PDF æª”æ¡ˆã€‚");
        ticketPdfInput.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        meta.ticketPdf = {
          name: file.name,
          dataUrl: e.target.result,
        };
        persistMeta();
        renderTicketStatus();
        showToast("å·²ä¸Šå‚³æ©Ÿç¥¨ PDF");
      };
      reader.readAsDataURL(file);
    }

    // --- åˆªé™¤å¡ç‰‡ ---
    function deleteCardById(cardId) {
      let changed = false;
      DAYS.forEach((day) => {
        PERIODS.forEach((p) => {
          const arr = state[day][p] || [];
          const idx = arr.findIndex((c) => c.id === cardId);
          if (idx !== -1) {
            arr.splice(idx, 1);
            changed = true;
          }
        });
      });
      if (changed) {
        persistState();
        renderBoard();
      }
    }

    // --- å„²å­˜ ---
    function persistState() {
      window.localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function persistMeta() {
      window.localStorage.setItem(META_KEY, JSON.stringify(meta));
    }

    // å•Ÿå‹•
    init();
  </script>
</body>
</html>
