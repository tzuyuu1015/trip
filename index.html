<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hokkaido V13.0 (Pro)</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FF6B00">
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js"></script>

    <style>
        :root {
            --bg-body: #FFFBF5;
            --primary: #FF6B00;
            --accent-flight: #FFC107;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --line-color: #E5E5EA;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --tab-height: calc(60px + var(--safe-bottom));
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--bg-body); color: var(--text-main);
            padding-bottom: calc(var(--tab-height) + 20px);
            padding-top: calc(50px + var(--safe-top));
            user-select: none; overflow-x: hidden;
        }

        /* Header */
        .header-wrapper {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            background: rgba(255, 251, 245, 0.95);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 10px 20px; padding-top: max(10px, var(--safe-top));
            border-bottom: 0.5px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
            height: calc(50px + var(--safe-top));
        }
        .header-left { display: flex; flex-direction: column; }
        .header-title { font-size: 22px; font-weight: 800; }
        .header-subtitle { font-size: 11px; color: var(--text-sub); }
        .settings-btn { width: 36px; height: 36px; background: #F2F2F7; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); cursor: pointer; transition: transform 0.1s; }
        .settings-btn:active { transform: scale(0.9); }

        /* Timeline */
        .timeline-container { padding: 20px 10px 80px 0; }
        .period-section { margin-bottom: 30px; }
        .period-label { font-size: 18px; font-weight: 800; color: var(--text-main); margin-bottom: 15px; padding-left: 20px; display: flex; align-items: center; }
        .period-label::before { content: ''; display: inline-block; width: 8px; height: 8px; background: var(--primary); border-radius: 50%; margin-right: 8px; }
        .timeline-item { display: flex; position: relative; margin-bottom: 20px; }
        .time-column { width: 55px; flex-shrink: 0; text-align: right; padding-right: 10px; padding-top: 12px; font-size: 13px; font-weight: 600; color: var(--text-main); font-variant-numeric: tabular-nums; }
        .time-column.no-time { color: transparent; }
        .timeline-axis { position: absolute; left: 55px; top: 0; bottom: -20px; width: 2px; background: var(--line-color); z-index: 0; }
        .timeline-dot { position: absolute; left: 50px; top: 16px; width: 12px; height: 12px; background: var(--bg-body); border: 2px solid var(--primary); border-radius: 50%; z-index: 1; }
        .card-column { flex: 1; min-width: 0; padding-right: 16px; }
        
        .card { background: #fff; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); position: relative; overflow: hidden; transition: transform 0.1s; cursor: pointer; margin-bottom: 12px; }
        .card:active { transform: scale(0.98); }
        .card-img { width: 100%; height: 140px; object-fit: cover; display: block; }
        .card-content { padding: 12px 14px 14px; }
        .card-title { font-size: 16px; font-weight: 700; margin-bottom: 4px; color: #000; line-height: 1.3; }
        .card-sub { font-size: 13px; color: #8E8E93; margin-bottom: 6px; font-weight: 500; display: flex; flex-direction: column; gap: 2px; }
        .card-note { font-size: 13px; color: #666; background: #F9F9F9; padding: 6px 10px; border-radius: 8px; display: inline-block; margin-top: 6px; line-height: 1.4; white-space: pre-wrap; }
        .map-btn { position: absolute; bottom: 12px; right: 12px; width: 36px; height: 36px; background: #FFF3E0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .map-icon { width: 20px; height: 20px; fill: currentColor; }
        .btn-delete { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; border-radius: 50%; background: rgba(0,0,0,0.05); border: none; color: #8E8E93; font-size: 14px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); z-index: 10; }
        .card.no-img .btn-delete { background: transparent; color: #C7C7CC; top: 4px; right: 4px; }

        /* Flight Card */
        .flight-card { background: #fff; border-radius: 16px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); position: relative; overflow: hidden; border-left: 6px solid var(--accent-flight); }
        .flight-header { background: #FFF8E1; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; }
        .flight-no { font-weight: 800; color: var(--accent-flight); font-size: 18px; }
        .flight-date { font-size: 13px; color: #666; font-weight: 600; }
        .flight-body { padding: 16px; display: flex; align-items: center; justify-content: space-between; }
        .airport-code { font-size: 24px; font-weight: 800; color: #000; }
        .flight-arrow { color: #ccc; font-size: 20px; }
        .flight-time { font-size: 13px; color: #666; margin-top: 4px; }
        .flight-footer { padding: 10px 16px; border-top: 1px dashed #eee; display: flex; gap: 10px; }
        .ticket-btn { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #E5E5EA; background: #fff; color: var(--primary); font-size: 14px; font-weight: 600; text-align: center; }

        /* Lists */
        .list-header { display: flex; justify-content: space-between; align-items: center; margin: 25px 0 10px; }
        .list-title { font-size: 14px; color: #8E8E93; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .add-icon-btn { color: var(--primary); font-size: 20px; font-weight: bold; cursor: pointer; padding: 0 10px; }
        .bullet-item { background: #fff; padding: 14px; border-bottom: 1px solid #F9F9F9; display: flex; align-items: flex-start; }
        .bullet-item:first-child { border-top-left-radius: 16px; border-top-right-radius: 16px; }
        .bullet-item:last-child { border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; border-bottom: none; }
        .bullet-dot { width: 6px; height: 6px; background: var(--text-main); border-radius: 50%; margin-top: 7px; margin-right: 12px; flex-shrink: 0; }
        .bullet-text { flex: 1; font-size: 15px; line-height: 1.4; }
        .check-item { background: #fff; padding: 14px; border-bottom: 1px solid #F9F9F9; display: flex; align-items: center; cursor: pointer; }
        .check-item:first-child { border-top-left-radius: 16px; border-top-right-radius: 16px; }
        .check-item:last-child { border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; border-bottom: none; }
        .check-box { width: 22px; height: 22px; border: 2px solid #C7C7CC; border-radius: 6px; margin-right: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
        .check-box.checked { background: var(--primary); border-color: var(--primary); }
        .check-box.checked::after { content: '‚úì'; color: #fff; font-size: 14px; font-weight: 800; }
        .check-text { flex: 1; font-size: 15px; }
        .check-text.done { color: #C7C7CC; text-decoration: line-through; }
        .item-del { color: #C7C7CC; font-size: 16px; padding: 0 0 0 10px; }

        /* Map & Price */
        .map-list-item { background: #fff; padding: 16px; border-radius: 16px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .map-list-icon { width: 40px; height: 40px; border-radius: 10px; background: var(--primary); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 14px; flex-shrink: 0; }
        .map-list-icon.food { background: #FF9500; }
        .map-list-info { flex: 1; }
        .map-list-title { font-weight: 600; font-size: 16px; margin-bottom: 2px; }
        .map-list-url { font-size: 12px; color: #C7C7CC; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .map-edit-btn { padding: 8px; color: #C7C7CC; }
        .price-calc-card { background: #fff; padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); text-align: center; }
        .calc-row { display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        .calc-input { font-size: 32px; font-weight: 800; width: 120px; text-align: center; border: none; border-bottom: 2px solid var(--primary); outline: none; color: var(--primary); background: transparent; }
        .calc-result { font-size: 32px; font-weight: 800; color: #1C1C1E; margin-left: 10px; }
        .tool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .tool-btn { background: #fff; padding: 16px; border-radius: 16px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); cursor: pointer; border: 1px solid rgba(0,0,0,0.05); }
        .search-bar-wrapper { position: relative; margin-bottom: 20px; }
        .search-input { width: 100%; padding: 14px 16px; padding-right: 50px; border: none; border-radius: 16px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.04); font-size: 16px; outline: none; }
        .search-btn { position: absolute; right: 8px; top: 8px; background: var(--primary); color: white; border: none; width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .section-head { margin: 25px 0 10px; font-size: 14px; color: #8E8E93; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }

        /* FAB & Tab Bar */
        .fab { position: fixed; bottom: calc(var(--safe-bottom) + 80px); right: 20px; width: 56px; height: 56px; background: #1C1C1E; border-radius: 20px; color: white; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); z-index: 999; }
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: var(--tab-height); background: rgba(255,251,245,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding-top: 8px; z-index: 1000; padding-bottom: var(--safe-bottom); }
        .tab-item { width: 20%; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; color: #999; }
        .tab-item.active { color: var(--primary); }
        .tab-icon { width: 24px; height: 24px; fill: currentColor; }

        /* Utils & Modal */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .day-scroller { display: flex; overflow-x: auto; gap: 10px; padding: 10px 20px; scrollbar-width: none; }
        .day-chip { background: white; color: var(--text-sub); padding: 8px 16px; border-radius: 99px; font-size: 14px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.05); white-space: nowrap; }
        .day-chip.active { background: #1C1C1E; color: #fff; transform: scale(1.05); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: flex-end; }
        .modal-overlay.show { display: flex; }
        .modal-sheet { background: #fff; width: 100%; max-width: 600px; border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 24px; padding-bottom: 50px; max-height: 90vh; overflow-y: auto; }
        .form-row { display: flex; gap: 10px; margin-bottom: 16px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 14px; background: #F9F9F9; border: none; border-radius: 12px; font-size: 16px; outline: none; margin-bottom: 16px; }
        .form-textarea { height: 80px; resize: none; }
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 14px; font-size: 16px; font-weight: 600; }
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 3000; display: none; align-items: center; justify-content: center; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading">ËôïÁêÜ‰∏≠...</div>

    <div class="header-wrapper">
        <div class="header-left">
            <div class="header-title" id="pageTitle">Hokkaido</div>
            <div class="header-subtitle" id="pageSubtitle">Day 1 ‚Ä¢ Ë°åÁ®ã</div>
        </div>
        <div class="settings-btn" onclick="openAddModal('settings_menu')">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
        </div>
    </div>

    <div id="page-itinerary" class="page active">
        <div class="day-scroller" id="dayScroller"></div>
        <div class="timeline-container" id="timelineContent"></div>
        <div class="fab" onclick="openAddModal('trip')">Ôºã</div>
    </div>

    <div id="page-mustdo" class="page">
        <div style="padding: 20px;">
            <div class="list-header"><div class="list-title">Á¥ÑÊ≥ï‰∏âÁ´†</div><div class="add-icon-btn" onclick="openAddModal('rule')">Ôºã</div></div>
            <div id="rulesContainer" style="border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,0.04); margin-bottom:20px; background:#fff;"></div>

            <div class="list-header"><div class="list-title">Ê≥®ÊÑè‰∫ãÈ†Ö</div><div class="add-icon-btn" onclick="openAddModal('note')">Ôºã</div></div>
            <div id="notesContainer" style="border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,0.04); margin-bottom:20px; background:#fff;"></div>

            <div class="list-header"><div class="list-title">ÂøÖÂÅöÊ∏ÖÂñÆ</div><div class="add-icon-btn" onclick="openAddModal('mustdo')">Ôºã</div></div>
            <div id="mustDoContainer" style="border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,0.04); margin-bottom:20px; background:#fff;"></div>
            
            <div class="list-header"><div class="list-title">ÂøÖË≤∑Ê∏ÖÂñÆ</div><div class="add-icon-btn" onclick="openAddModal('mustbuy')">Ôºã</div></div>
            <div id="mustBuyContainer" style="border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,0.04); margin-bottom:20px; background:#fff;"></div>
        </div>
    </div>

    <div id="page-wallet" class="page">
        <div style="padding:20px;">
            <div class="section-head">‚úàÔ∏è Ëà™Áè≠Ë≥áË®ä (PDF)</div>
            <div id="flightList"></div>
            <div class="section-head">üè® ‰ΩèÂÆøÊÜëË≠â</div>
            <div id="hotelList"></div>
            <div class="section-head">üéü ÊôØÈªûÈñÄÁ•® & JR Pass</div>
            <div id="ticketList"></div>
        </div>
        <div class="fab" onclick="openAddModal('ticket_choice')">Ôºã</div>
    </div>

    <div id="page-map" class="page">
        <div style="padding: 20px;">
            <h3 style="margin: 10px 0 15px; font-size:14px; color:#8E8E93; text-transform:uppercase;">ÊàëÁöÑËá™Ë®ÇÂú∞Âúñ</h3>
            <div id="mapListContainer"></div>
            <p style="color:#8E8E93; font-size:12px; margin-top:20px; line-height:1.5;">üí° ÈªûÊìä‰∏äÊñπÊ∏ÖÂñÆÔºåÁõ¥Êé•ÈñãÂïü Google Maps ÂúñÂ±§„ÄÇ</p>
        </div>
    </div>

    <div id="page-price" class="page">
        <div style="padding: 20px;">
            <div class="price-calc-card">
                <div style="font-size:12px;color:#8E8E93;cursor:pointer;" onclick="changeRate()">ÂåØÁéá: <span id="currentRateDisplay">0.215</span> ‚úé</div>
                <div class="calc-row">
                    <span style="font-size:20px; color:#8E8E93;">¬•</span>
                    <input type="number" id="calcJpy" class="calc-input" placeholder="0" oninput="calculatePrice()">
                    <span style="font-size:20px; color:#8E8E93; margin:0 8px;">=</span>
                    <span style="font-size:20px; color:#8E8E93;">$</span>
                    <span id="calcTwd" class="calc-result">0</span>
                </div>
            </div>
            <h3 style="margin: 0 0 10px; font-size:14px; color:#8E8E93; text-transform:uppercase;">ÂïÜÂìÅÊØîÂÉπ</h3>
            <div class="search-bar-wrapper">
                <input type="text" id="priceKeyword" class="search-input" placeholder="Ëº∏ÂÖ•ÂïÜÂìÅÂêçÁ®±">
                <button class="search-btn" onclick="searchBigGo()">üîç</button>
            </div>
            <div class="tool-grid">
                <div class="tool-btn" onclick="openGoogleImageSearch()"><span class="tool-icon">üì∑</span><div class="tool-name">ÊãçÁÖßÊêúÂúñ</div><div class="tool-desc">Google ÂúñÁâáÊêúÂ∞ã</div></div>
                <div class="tool-btn" onclick="searchShopee()"><span class="tool-icon">üõçÔ∏è</span><div class="tool-name">ÊêúËù¶ÁöÆ</div><div class="tool-desc">Êü•Âè∞ÁÅ£ÂÉπÊ†º</div></div>
            </div>
        </div>
    </div>

    <nav class="tab-bar">
        <div class="tab-item active" onclick="switchTab('itinerary')"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/></svg><span>Ë°åÁ®ã</span></div>
        <div class="tab-item" onclick="switchTab('mustdo')"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M14 17H4v2h10v-2zm6-8H4v2h16V9zM4 15h16v-2H4v2zM4 5v2h16V5H4z"/></svg><span>Ê∏ÖÂñÆ</span></div>
        <div class="tab-item" onclick="switchTab('wallet')"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.1.89 2 2 2h16c1.1 0 2-.89 2-2V6c0-1.1-.89-2-2-2zm-5 14H4v-6h11v6zm0-9H4V6h11v3z"/></svg><span>ÊÜëË≠â</span></div>
        <div class="tab-item" onclick="switchTab('map')"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg><span>Âú∞Âúñ</span></div>
        <div class="tab-item" onclick="switchTab('price')"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg><span>ÊØîÂÉπ</span></div>
    </nav>

    <div class="modal-overlay" id="addModal" onclick="if(event.target===this) closeModal()">
        <div class="modal-sheet">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 id="modalTitle" style="margin:0;">Êñ∞Â¢û</h3>
                <span onclick="closeModal()" style="color:#999; cursor:pointer;">ÂèñÊ∂à</span>
            </div>
            <div id="modalBody"></div>
            <button class="btn" id="modalSaveBtn">ÂÑ≤Â≠ò</button>
        </div>
    </div>

    <input type="file" id="restoreInput" style="display:none" accept=".json">

    <script>
        const DAYS = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6'];
        const PERIODS = ['morning', 'afternoon', 'evening'];
        const PERIOD_LABEL = { morning: 'Êó©ÂÆâ Morning', afternoon: 'ÂçàÂÆâ Afternoon', evening: 'ÊôöÂÆâ Evening' };
        const DB_NAME = 'HokkaidoApp';
        const STORE_NAME = 'data';

        // --- IndexedDB Wrapper (Using idb-keyval lib logic) ---
        const dbPromise = idbKeyval.createStore(DB_NAME, STORE_NAME);

        let appData = { 
            activeDay: 'Day 1', mustDo: [], mustBuy: [], coupleRules: [], notes: [], 
            itinerary: {}, hotels: [], tickets: [], flights: [],
            maps: [{ name: 'ÂåóÊµ∑ÈÅìÊôØÈªû', url: 'https://maps.app.goo.gl/YCiJYAw3ZDBpatnp9', type: 'place' }, { name: 'ÂåóÊµ∑ÈÅìÁæéÈ£ü', url: 'https://maps.app.goo.gl/E8PcCWDnZKVuzN618', type: 'food' }],
            rate: 0.215
        };

        async function init() {
            DAYS.forEach(d => { if(!appData.itinerary[d]) appData.itinerary[d] = { morning:[], afternoon:[], evening:[] }; });
            
            try {
                const saved = await idbKeyval.get('appData', dbPromise);
                if(saved) appData = { ...appData, ...saved };
            } catch(e) { console.error(e); }

            // Checks
            if(!appData.flights) appData.flights=[]; if(!appData.mustBuy) appData.mustBuy=[]; 
            if(!Array.isArray(appData.coupleRules)) appData.coupleRules=[]; if(!Array.isArray(appData.notes)) appData.notes=[];
            if(!appData.maps) appData.maps=[];

            renderDayScroller(); renderTimeline(); renderOthers(); renderMaps(); updateRateDisplay();
            document.getElementById('restoreInput').addEventListener('change', handleRestoreFile);
        }

        async function saveData() { await idbKeyval.set('appData', appData, dbPromise); }

        // --- Helpers ---
        function getHoursForPeriod(p) {
            let start=0, end=23;
            if(p === 'morning') { start = 5; end = 12; }
            else if(p === 'afternoon') { start = 13; end = 17; }
            else if(p === 'evening') { start = 18; end = 24; }
            let opts = '<option value="">-ÊôÇ-</option>';
            for(let i=start; i<=end; i++) {
                let val = i === 24 ? '00' : i.toString().padStart(2,'0');
                opts += `<option value="${val}">${val}</option>`;
            }
            return opts;
        }
        function compressImage(f) { return new Promise(r=>{ const rd=new FileReader(); rd.onload=e=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{ const c=document.createElement('canvas'); const x=c.getContext('2d'); const s=600/i.width; c.width=(i.width>600)?600:i.width; c.height=(i.width>600)?i.height*s:i.height; x.drawImage(i,0,0,c.width,c.height); r(c.toDataURL('image/jpeg',0.7)); }; }; rd.readAsDataURL(f); }); }
        function readPdf(f) { return new Promise(r=>{ const rd=new FileReader(); rd.onload=e=>r(e.target.result); rd.readAsDataURL(f); }); }

        // --- Render ---
        function renderTimeline() {
            const container = document.getElementById('timelineContent'); container.innerHTML = '';
            const dayData = appData.itinerary[appData.activeDay];
            let hasItem = false;
            PERIODS.forEach(p => {
                let items = dayData[p] || [];
                items.sort((a, b) => { if (!a.hh) return 1; if (!b.hh) return -1; return (a.hh * 60 + parseInt(a.mm)) - (b.hh * 60 + parseInt(b.mm)); });
                if (items.length > 0) {
                    hasItem = true;
                    const group = document.createElement('div'); group.className = 'period-section';
                    group.innerHTML = `<div class="period-label">${PERIOD_LABEL[p]}</div>`;
                    items.forEach((item, idx) => {
                        let mapLink = item.mapUrl || (item.title ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.title)}` : '');
                        const timeDisplay = (item.hh && item.mm) ? `${item.hh}:${item.mm}` : '';
                        const imgHtml = item.image ? `<img src="${item.image}" class="card-img" loading="lazy">` : '';
                        const cardClass = item.image ? 'card' : 'card no-img';
                        group.innerHTML += `<div class="timeline-item"><div class="time-column ${timeDisplay ? '' : 'no-time'}">${timeDisplay || '--:--'}</div><div class="timeline-axis"></div><div class="timeline-dot"></div><div class="card-column"><div class="${cardClass}" onclick="openAddModal('trip', ${idx}, '${p}')">${imgHtml}<div class="card-content"><div class="card-title">${item.title}</div>${item.note ? `<div class="card-note">${item.note}</div>` : ''}</div><button class="btn-delete" onclick="event.stopPropagation(); deleteTrip('${p}', ${idx})">‚úï</button><div class="map-btn" onclick="event.stopPropagation(); openMap('${mapLink}')"><svg class="map-icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></div></div></div></div>`;
                    });
                    container.appendChild(group);
                }
            });
            if(!hasItem) container.innerHTML = `<div style="text-align:center; color:#ccc; margin-top:50px;">ÈÇÑÊ≤íÊúâË°åÁ®ã<br>ÈªûÊìäÂè≥‰∏ãËßí Ôºã Êñ∞Â¢û</div>`;
        }

        function renderOthers() {
            const rc = document.getElementById('rulesContainer'); rc.innerHTML = '';
            appData.coupleRules.forEach((r, i) => rc.innerHTML += `<div class="bullet-item"><div class="bullet-dot"></div><div class="bullet-text">${r}</div><div onclick="deleteOther('coupleRules', ${i})" style="color:#C7C7CC; margin-left:10px; cursor:pointer;">‚úï</div></div>`);
            if(!appData.coupleRules.length) rc.innerHTML = `<div style="padding:10px;text-align:center;color:#ccc;font-size:13px;">ÁÑ°</div>`;

            const nc = document.getElementById('notesContainer'); nc.innerHTML = '';
            appData.notes.forEach((n, i) => nc.innerHTML += `<div class="bullet-item"><div class="bullet-dot"></div><div class="bullet-text">${n}</div><div onclick="deleteOther('notes', ${i})" style="color:#C7C7CC; margin-left:10px; cursor:pointer;">‚úï</div></div>`);
            if(!appData.notes.length) nc.innerHTML = `<div style="padding:10px;text-align:center;color:#ccc;font-size:13px;">ÁÑ°</div>`;

            const mc = document.getElementById('mustDoContainer'); mc.innerHTML = '';
            appData.mustDo.forEach((m, i) => mc.innerHTML += `<div class="check-item" onclick="toggleItem('mustDo', ${i})"><div class="check-box ${m.done?'checked':''}"><div class="check-icon"></div></div><div class="check-text ${m.done?'done':''}">${m.text}</div><div class="item-del" onclick="event.stopPropagation(); deleteOther('mustDo', ${i})">‚úï</div></div>`);
            
            const mb = document.getElementById('mustBuyContainer'); mb.innerHTML = '';
            appData.mustBuy.forEach((m, i) => mb.innerHTML += `<div class="check-item" onclick="toggleItem('mustBuy', ${i})"><div class="check-box ${m.done?'checked':''}"><div class="check-icon"></div></div><div class="check-text ${m.done?'done':''}">${m.text}</div><div class="item-del" onclick="event.stopPropagation(); deleteOther('mustBuy', ${i})">‚úï</div></div>`);

            const hc = document.getElementById('hotelList'); hc.innerHTML = '';
            appData.hotels.forEach((x, i) => {
                let mapLink = x.mapUrl || (x.name ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(x.name)}` : '');
                let timeInfo = (x.checkIn || x.checkOut) ? `ÂÖ•‰Ωè ${x.checkIn || '--'} / ÈÄÄÊàø ${x.checkOut || '--'}` : (x.date || "");
                hc.innerHTML += `<div class="card" style="cursor:default;"><div class="card-content"><div class="card-title">${x.name}</div><div class="card-sub">${timeInfo}</div>${x.note ? `<div class="card-note">${x.note}</div>` : ''}<div style="margin-top:10px;">${x.file ? `<button onclick="openFile('${x.file}')" style="width:100%; padding:8px; border:1px solid #eee; background:#fff; color:#007AFF; border-radius:8px; font-size:13px;">Êü•ÁúãÊÜëË≠â</button>` : ''}</div></div><button class="btn-delete" onclick="deleteOther('hotels', ${i})">‚úï</button><div class="map-btn" onclick="openMap('${mapLink}')"><svg class="map-icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></div></div>`;
            });

            const tc = document.getElementById('ticketList'); tc.innerHTML = '';
            appData.tickets.forEach((x, i) => {
                tc.innerHTML += `<div class="card" style="cursor:default;"><div class="card-content"><div class="card-title">${x.name}</div><div class="card-sub">${x.date}</div><div style="margin-top:10px;">${x.file ? `<button onclick="openFile('${x.file}')" style="width:100%; padding:8px; border:1px solid #eee; background:#fff; color:#007AFF; border-radius:8px; font-size:13px;">Êü•ÁúãÊÜëË≠â</button>` : ''}</div></div><button class="btn-delete" onclick="deleteOther('tickets', ${i})">‚úï</button></div>`;
            });

            const fc = document.getElementById('flightList'); fc.innerHTML = '';
            appData.flights.forEach((f, i) => fc.innerHTML += `<div class="flight-card"><div class="flight-header"><span class="flight-no">‚úà ${f.no}</span><span class="flight-date">${f.date}</span></div><div class="flight-body"><div style="text-align:center;"><div class="airport-code">${f.dep}</div><div class="flight-time">${f.depTime}</div></div><div class="flight-arrow">‚ûù</div><div style="text-align:center;"><div class="airport-code">${f.arr}</div><div class="flight-time">${f.arrTime}</div></div></div><div class="flight-footer">${f.file ? `<div class="ticket-btn" onclick="openFile('${f.file}')">ÈõªÂ≠êÊ©üÁ•®</div>` : ''}<div class="ticket-btn" style="color:#FF3B30; flex:0.3;" onclick="deleteOther('flights', ${i})">‚úï</div></div></div>`);
        }

        function renderMaps() {
            const container = document.getElementById('mapListContainer'); container.innerHTML = '';
            appData.maps.forEach((m, idx) => {
                const icon = m.type === 'food' ? 'üçú' : 'üó∫Ô∏è';
                const cls = m.type === 'food' ? 'map-list-icon food' : 'map-list-icon';
                container.innerHTML += `<div class="map-list-item" onclick="openMap('${m.url}')"><div class="${cls}">${icon}</div><div class="map-list-info"><div class="map-list-title">${m.name}</div><div class="map-list-url">${m.url}</div></div><div class="map-edit-btn" onclick="event.stopPropagation(); openAddModal('edit_map', ${idx})">‚úé</div></div>`;
            });
        }

        // --- Actions ---
        function switchTab(t) {
            document.querySelectorAll('.tab-item').forEach(e=>e.classList.remove('active'));
            document.querySelector(`.tab-item[onclick="switchTab('${t}')"]`).classList.add('active');
            document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
            document.getElementById(`page-${t}`).classList.add('active');
            const titles = { itinerary:'Hokkaido', mustdo:'Checklist', wallet:'Wallet', map:'Map', price:'Price' };
            const subs = { itinerary:`${appData.activeDay} ‚Ä¢ Ë°åÁ®ã`, mustdo:'Ê∏ÖÂñÆ', wallet:'ÊÜëË≠â', map:'Êé¢Á¥¢', price:'ÊØîÂÉπ' };
            document.getElementById('pageTitle').innerText = titles[t];
            document.getElementById('pageSubtitle').innerText = subs[t];
        }
        function renderDayScroller() {
            const c = document.getElementById('dayScroller'); c.innerHTML = '';
            DAYS.forEach(d => {
                const el = document.createElement('div'); el.className = `day-chip ${appData.activeDay===d?'active':''}`;
                el.innerText = d; el.onclick = () => { appData.activeDay = d; saveData(); renderDayScroller(); renderTimeline(); document.getElementById('pageSubtitle').innerText = `${d} ‚Ä¢ Ë°åÁ®ã`; };
                c.appendChild(el);
            });
        }
        function deleteTrip(p, i) { if(confirm('Âà™Èô§Ôºü')) { appData.itinerary[appData.activeDay][p].splice(i,1); saveData(); renderTimeline(); }}
        function deleteOther(t, i) { if(confirm('Âà™Èô§Ôºü')) { appData[t].splice(i,1); saveData(); renderOthers(); }}
        function toggleItem(type, i) { appData[type][i].done = !appData[type][i].done; saveData(); renderOthers(); }
        function openMap(u) { window.open(u, '_blank'); }
        function openFile(u) { const w = window.open(); w.document.write(`<iframe src="${u}" style="width:100%;height:100%;border:0;"></iframe>`); }
        
        async function exportData() {
            const dataStr = JSON.stringify(appData);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `hokkaido_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
        }
        function triggerImport() { document.getElementById('restoreInput').click(); }
        function handleRestoreFile(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try { appData = JSON.parse(e.target.result); saveData(); location.reload(); } catch(err) { alert("Ê™îÊ°àÈåØË™§"); }
            }; reader.readAsText(file);
        }
        async function resetAllData() { if(confirm('Ê∏ÖÁ©∫Ôºü')) { await idbKeyval.clear(dbPromise); location.reload(); } }
        
        function calculatePrice() { const jpy = parseFloat(document.getElementById('calcJpy').value) || 0; document.getElementById('calcTwd').innerText = Math.round(jpy * appData.rate); }
        function updateRateDisplay() { document.getElementById('currentRateDisplay').innerText = appData.rate; }
        function changeRate() { const r = prompt("ÂåØÁéá:", appData.rate); if(r && !isNaN(r)) { appData.rate = parseFloat(r); saveData(); updateRateDisplay(); } }
        function searchBigGo() { const k = document.getElementById('priceKeyword').value; if(k) window.open(`https://biggo.com.tw/s/${encodeURIComponent(k)}`, '_blank'); }
        function searchShopee() { const k = document.getElementById('priceKeyword').value; if(k) window.open(`https://shopee.tw/search?keyword=${encodeURIComponent(k)}`, '_blank'); }
        function openGoogleImageSearch() { window.open('https://www.google.com/imghp?hl=zh-TW', '_blank'); }

        // --- Modal ---
        let currType = '', editIdx = -1, editParent = ''; 
        function openAddModal(type, idx = -1, parent = '') {
            currType = type; editIdx = idx; editParent = parent;
            const b = document.getElementById('modalBody'); const title = document.getElementById('modalTitle');
            const saveBtn = document.getElementById('modalSaveBtn'); saveBtn.style.display = 'block';

            if (type === 'settings_menu') {
                title.innerText = "Ë®≠ÂÆö";
                b.innerHTML = `<button class="btn" onclick="exportData()" style="margin-bottom:12px; background:#fff; color:#000; border:1px solid #eee;">üì§ ‰∏ãËºâÂÇô‰ªΩ</button><button class="btn" onclick="triggerImport()" style="margin-bottom:12px; background:#fff; color:#000; border:1px solid #eee;">üì• ÈÇÑÂéüÂÇô‰ªΩ</button><button class="btn" onclick="resetAllData()" style="background:#FF3B30; color:#fff;">üóë Ê∏ÖÁ©∫Ë≥áÊñô</button>`;
                saveBtn.style.display = 'none';
            } else if (type === 'ticket_choice') {
                title.innerText = "ÈÅ∏Êìá";
                b.innerHTML = `<button class="btn" onclick="openAddModal('flight')" style="margin-bottom:10px; background:#FFF3E0; color:var(--primary);">‚úàÔ∏è Êñ∞Â¢ûËà™Áè≠</button><button class="btn" onclick="openAddModal('hotel')" style="margin-bottom:10px; background:#F9F9F9; color:#000;">üè® Êñ∞Â¢û‰ΩèÂÆø</button><button class="btn" onclick="openAddModal('ticket')" style="background:#F9F9F9; color:#000;">üéü Êñ∞Â¢ûÈñÄÁ•®</button>`;
                saveBtn.style.display = 'none';
            } else if (type === 'mustdo_choice') {
                title.innerText = "Êñ∞Â¢û";
                b.innerHTML = `<button class="btn" onclick="openAddModal('mustdo')" style="margin-bottom:10px; background:#FFF3E0; color:var(--primary);">‚úÖ ÂøÖÂÅö</button><button class="btn" onclick="openAddModal('mustbuy')" style="background:#F9F9F9; color:#000;">üõçÔ∏è ÂøÖË≤∑</button>`;
                saveBtn.style.display = 'none';
            } else if (type === 'edit_map') {
                title.innerText = "Á∑®ËºØÂú∞Âúñ"; const m = appData.maps[idx];
                b.innerHTML = `<input id="inpTitle" class="form-input" value="${m.name}" placeholder="ÂêçÁ®±"><input id="inpMap" class="form-input" value="${m.url}" placeholder="URL">`;
            } else if (type === 'trip') {
                title.innerText = idx === -1 ? "Êñ∞Â¢ûË°åÁ®ã" : "Á∑®ËºØË°åÁ®ã";
                const item = idx !== -1 ? appData.itinerary[appData.activeDay][parent][idx] : {};
                const pVal = parent || 'morning';
                b.innerHTML = `<select id="inpPeriod" class="form-select" onchange="updateHHOptions(this.value)"><option value="morning">Morning</option><option value="afternoon">Afternoon</option><option value="evening">Evening</option></select><div class="form-row"><select id="inpHH" class="form-select"></select><select id="inpMM" class="form-select"><option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option></select></div><input id="inpTitle" class="form-input" placeholder="ÂêçÁ®± *"><input id="inpMap" class="form-input" placeholder="Map ÈÄ£Áµê"><div style="font-size:14px;color:#666;margin-bottom:6px;">ÁÖßÁâá (‰∏çÈÅ∏Ââá‰øùÁïôÂéüÂúñ)</div><input id="inpImg" type="file" accept="image/*" class="form-input"><textarea id="inpNote" class="form-textarea" placeholder="ÂÇôË®ª..."></textarea>`;
                document.getElementById('inpPeriod').value = pVal; updateHHOptions(pVal);
                if(idx !== -1) {
                    document.getElementById('inpTitle').value = item.title || '';
                    document.getElementById('inpHH').value = item.hh || '';
                    document.getElementById('inpMM').value = item.mm || '00';
                    document.getElementById('inpMap').value = item.mapUrl || '';
                    document.getElementById('inpNote').value = item.note || '';
                }
            } else if (type === 'flight') {
                b.innerHTML = `<input id="inpNo" class="form-input" placeholder="Ëà™Áè≠ (JX801)"><input id="inpDate" class="form-input" placeholder="Êó•Êúü (2/14)"><div class="form-row"><input id="inpDep" class="form-input" placeholder="TPE"><input id="inpDepTime" class="form-input" placeholder="10:00"></div><div class="form-row"><input id="inpArr" class="form-input" placeholder="CTS"><input id="inpArrTime" class="form-input" placeholder="15:00"></div><div style="font-size:14px;color:#666;margin-bottom:6px;">Ê©üÁ•® PDF</div><input id="inpFile" type="file" accept="application/pdf" class="form-input">`;
            } else if (type === 'hotel') {
                title.innerText = "Êñ∞Â¢û‰ΩèÂÆø";
                b.innerHTML = `<input id="inpTitle" class="form-input" placeholder="È£ØÂ∫óÂêçÁ®± *"><div class="form-row"><input id="inpCheckIn" class="form-input" placeholder="ÂÖ•‰Ωè (15:00)"><input id="inpCheckOut" class="form-input" placeholder="ÈÄÄÊàø (11:00)"></div><input id="inpMap" class="form-input" placeholder="Google Map Âú∞ÂùÄ/ÈÄ£Áµê"><textarea id="inpNote" class="form-textarea" placeholder="ÂÇôË®ª (Âá∫Âè£„ÄÅÂØÑÊîæË°åÊùé...)"></textarea><div style="font-size:14px;color:#666;margin-bottom:6px;">ÊÜëË≠â PDF</div><input id="inpFile" type="file" accept="application/pdf" class="form-input">`;
            } else if (type === 'ticket') {
                title.innerText = "Êñ∞Â¢ûÈñÄÁ•®";
                b.innerHTML = `<input id="inpTitle" class="form-input" placeholder="ÈñÄÁ•®ÂêçÁ®± *"><input id="inpDate" class="form-input" placeholder="‰ΩøÁî®Êó•Êúü"><div style="font-size:14px;color:#666;margin-bottom:6px;">ÊÜëË≠â PDF</div><input id="inpFile" type="file" accept="application/pdf" class="form-input">`;
            } else { 
                title.innerText = "Êñ∞Â¢ûÈ†ÖÁõÆ";
                b.innerHTML = `<input id="inpTitle" class="form-input" placeholder="ÂÖßÂÆπ">`;
            }
            document.getElementById('addModal').classList.add('show');
        }
        
        function updateHHOptions(p) { document.getElementById('inpHH').innerHTML = getHoursForPeriod(p); }
        function closeModal() { document.getElementById('addModal').classList.remove('show'); }

        document.getElementById('modalSaveBtn').onclick = async () => {
            const loading = document.getElementById('loading'); loading.style.display = 'flex';
            const titleVal = document.getElementById('inpTitle') ? document.getElementById('inpTitle').value : '';
            
            if (currType === 'edit_map') {
                appData.maps[editIdx].name = titleVal; appData.maps[editIdx].url = document.getElementById('inpMap').value; renderMaps();
            } else if(currType === 'trip') {
                if(!titleVal) { alert('Ë´ãËº∏ÂÖ•ÂêçÁ®±'); loading.style.display='none'; return; }
                const newPeriod = document.getElementById('inpPeriod').value;
                let imgData = null; const imgInput = document.getElementById('inpImg');
                if(imgInput && imgInput.files[0]) imgData = await compressImage(imgInput.files[0]);
                else if (editIdx !== -1) imgData = appData.itinerary[appData.activeDay][editParent][editIdx].image;
                const newItem = { title:titleVal, hh: document.getElementById('inpHH').value, mm: document.getElementById('inpMM').value, mapUrl: document.getElementById('inpMap').value, note: document.getElementById('inpNote').value, image: imgData };
                if(editIdx !== -1) appData.itinerary[appData.activeDay][editParent].splice(editIdx, 1);
                appData.itinerary[appData.activeDay][newPeriod].push(newItem); renderTimeline();
            } else if (currType === 'flight') {
                let fData = null; const fInput = document.getElementById('inpFile');
                if(fInput && fInput.files[0]) fData = await readPdf(fInput.files[0]);
                appData.flights.push({ no:document.getElementById('inpNo').value, date:document.getElementById('inpDate').value, dep:document.getElementById('inpDep').value, depTime:document.getElementById('inpDepTime').value, arr:document.getElementById('inpArr').value, arrTime:document.getElementById('inpArrTime').value, file:fData }); renderOthers();
            } else if (currType === 'hotel') {
                let fData = null; const fInput = document.getElementById('inpFile');
                if(fInput && fInput.files[0]) fData = await readPdf(fInput.files[0]);
                appData.hotels.push({ name: titleVal, checkIn: document.getElementById('inpCheckIn').value, checkOut: document.getElementById('inpCheckOut').value, mapUrl: document.getElementById('inpMap').value, note: document.getElementById('inpNote').value, file: fData }); renderOthers();
            } else if (currType === 'ticket') {
                let fData = null; const fInput = document.getElementById('inpFile');
                if(fInput && fInput.files[0]) fData = await readPdf(fInput.files[0]);
                appData.tickets.push({ name: titleVal, date: document.getElementById('inpDate').value, file: fData }); renderOthers();
            } else if (currType === 'rule') { appData.coupleRules.push(titleVal); renderOthers(); }
            else if (currType === 'note') { appData.notes.push(titleVal); renderOthers(); }
            else if (currType === 'mustdo') { appData.mustDo.push({text:titleVal, done:false}); renderOthers(); }
            else if (currType === 'mustbuy') { appData.mustBuy.push({text:titleVal, done:false}); renderOthers(); }
            
            await saveData(); loading.style.display = 'none'; closeModal();
        };

        init();
    </script>
</body>
</html>