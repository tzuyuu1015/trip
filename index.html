<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>åŒ—æµ·é“è¡Œç¨‹çœ‹æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --accent: #4f46e5;
      --accent-soft: #eef2ff;
      --text-main: #111827;
      --text-sub: #6b7280;
      --border: #e5e7eb;
      --radius-lg: 18px;
      --radius-sm: 10px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 80px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px;
    }

    header h1 {
      font-size: 22px;
      margin: 0;
    }

    header p {
      margin: 0;
      font-size: 13px;
      color: var(--text-sub);
    }

    .toolbar {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .toolbar-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #374151;
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .toolbar-btn span {
      font-size: 14px;
    }

    .toolbar-btn:hover {
      background: #e5e7eb;
    }

    /* Board layout */
    .board-wrapper {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 10px 6px 12px;
      overflow-x: auto;
    }

    .board {
      display: flex;
      gap: 10px;
      min-height: 260px;
    }

    .day-column {
      background: var(--accent-soft);
      border-radius: 14px;
      padding: 8px;
      min-width: 210px;
      max-width: 240px;
      display: flex;
      flex-direction: column;
      max-height: 520px;
    }

    .day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .day-title {
      font-weight: 600;
      font-size: 14px;
    }

    .day-date {
      font-size: 11px;
      color: var(--text-sub);
    }

    .card-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-sm);
      padding: 6px;
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.06);
      margin-bottom: 6px;
      display: flex;
      gap: 6px;
      position: relative;
      flex-direction: row;
    }

    .card img {
      width: 70px;
      height: 70px;
      border-radius: 10px;
      object-fit: cover;
      flex-shrink: 0;
      background: #e5e7eb;
    }

    .card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .card-title-row {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      align-items: baseline;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-time {
      font-size: 11px;
      color: var(--accent);
      flex-shrink: 0;
    }

    .card-note {
      font-size: 11px;
      color: var(--text-sub);
      max-height: 4.2em;
      overflow: hidden;
    }

    .card-footer {
      margin-top: 4px;
      display: flex;
      justify-content: flex-start;
      gap: 6px;
      align-items: center;
    }

    .map-link-btn {
      border-radius: 999px;
      border: 1px solid #c7d2fe;
      background: #e0e7ff;
      color: #3730a3;
      font-size: 11px;
      padding: 3px 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      cursor: pointer;
      white-space: nowrap;
    }

    .map-link-btn span {
      font-size: 13px;
    }

    .map-link-btn:hover {
      background: #c7d2fe;
    }

    .card-delete {
      position: absolute;
      right: 4px;
      top: 2px;
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 14px;
      cursor: pointer;
      padding: 2px;
    }

    .card-delete:hover {
      color: #ef4444;
    }

    .add-btn {
      margin-top: 2px;
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 6px 0;
      font-size: 12px;
      background: #e0e7ff;
      color: #3730a3;
      cursor: pointer;
    }

    .add-btn:hover {
      background: #c7d2fe;
    }

    /* å…±ç”¨ Modal èƒŒæ™¯ */
    .modal-backdrop,
    .modal-backdrop-io {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
      z-index: 20;
    }

    .modal-backdrop.show,
    .modal-backdrop-io.show {
      display: flex;
    }

    .modal {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 14px;
      width: 100%;
      max-width: 420px;
      box-shadow: var(--shadow-soft);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h2 {
      font-size: 16px;
      margin: 0;
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      color: var(--text-sub);
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 12px;
    }

    .field label {
      color: var(--text-sub);
    }

    .field input,
    .field textarea,
    .field select {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      font-size: 13px;
      font-family: inherit;
    }

    .field textarea {
      min-height: 60px;
      resize: vertical;
    }

    .field small {
      font-size: 11px;
      color: var(--text-sub);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .io-textarea {
      width: 100%;
      min-height: 140px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px;
    }

    .tips {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-sub);
    }

    .io-helper {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 6px;
    }

    /* Mobile tweaks */
    @media (max-width: 768px) {
      .board {
        min-width: 100%;
      }

      .day-column {
        min-width: 78vw;
        max-width: 82vw;
      }

      header h1 {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>åŒ—æµ·é“è¡Œç¨‹çœ‹æ¿</h1>
      <p>Day1ï½Day6 çœ‹æ¿ï¼Œå¯æ–°å¢æ™¯é»ã€åœ–ç‰‡ï¼Œä¸€éµé–‹å•Ÿ Google Mapsï¼Œä¹Ÿå¯åŒ¯å‡º / åŒ¯å…¥åˆ°å…¶ä»–è£ç½®ã€‚</p>

      <div class="toolbar">
        <button class="toolbar-btn" id="exportBtn" type="button">
          <span>â¬†ï¸</span> åŒ¯å‡ºè¡Œç¨‹
        </button>
        <button class="toolbar-btn" id="importBtn" type="button">
          <span>â¬‡ï¸</span> åŒ¯å…¥è¡Œç¨‹
        </button>
      </div>
    </header>

    <div class="board-wrapper">
      <div class="board" id="board">
        <!-- JS ç”¢ç”Ÿ Day 1~Day 6 -->
      </div>
    </div>

    <div class="tips">
      âœ… æ¯å°è£ç½®å„è‡ªä¿å­˜ä¸€ä»½è¡Œç¨‹ï¼ˆlocalStorageï¼‰<br />
      âœ… æƒ³å¾é›»è…¦æ¬åˆ°æ‰‹æ©Ÿï¼šé›»è…¦æŒ‰ã€ŒåŒ¯å‡ºè¡Œç¨‹ã€è¤‡è£½æ–‡å­— â†’ å‚³åˆ°æ‰‹æ©Ÿ â†’ æ‰‹æ©ŸæŒ‰ã€ŒåŒ¯å…¥è¡Œç¨‹ã€è²¼ä¸Š â†’ å¥—ç”¨<br />
      âœ… Map æ¬„ä½ä¸å¡«æ™‚ï¼Œæœƒç”¨ã€Œæ™¯é»åç¨±ã€ç•¶ä½œ Google Maps æœå°‹é—œéµå­—
    </div>
  </div>

  <!-- æ–°å¢æ™¯é» Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>æ–°å¢æ™¯é»</h2>
        <button class="modal-close" id="modalCloseBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label for="daySelect">å“ªä¸€å¤©</label>
          <select id="daySelect"></select>
        </div>
        <div class="field">
          <label for="titleInput">æ™¯é» / æ´»å‹•åç¨± *</label>
          <input
            id="titleInput"
            type="text"
            placeholder="ä¾‹å¦‚ï¼šå°æ¨½é‹æ²³ã€æœ­å¹Œé›»è¦–å¡”"
          />
        </div>
        <div class="field">
          <label for="timeInput">æ™‚é–“ï¼ˆé¸å¡«ï¼‰</label>
          <input id="timeInput" type="text" placeholder="ä¾‹å¦‚ï¼š09:30ã€ä¸‹åˆ" />
        </div>
        <div class="field">
          <label for="noteInput">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
          <textarea
            id="noteInput"
            placeholder="è¦åƒçš„åº—ã€äº¤é€šæ–¹å¼ã€å°æé†’..."
          ></textarea>
        </div>
        <div class="field">
          <label for="mapInput">Map åœ°å€ / é—œéµå­—æˆ–ç¶²å€ï¼ˆé¸å¡«ï¼‰</label>
          <input
            id="mapInput"
            type="text"
            placeholder="ä¸å¡«å‰‡ç”¨æ™¯é»åç¨±æœå°‹ï¼›ä¹Ÿå¯ç›´æ¥è²¼ Google Maps é€£çµ"
          />
          <small>ä¾‹å¦‚ï¼šã€Œæœ­å¹Œé›»è¦–å¡”ã€ã€ã€Œå°æ¨½é‹æ²³ã€ã€ã€ŒåŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®å€â€¦ã€æˆ–è²¼æ•´å€‹ Google Maps URLã€‚</small>
        </div>
        <div class="field">
          <label for="imageInput">åœ–ç‰‡ç¶²å€ï¼ˆé¸å¡«ï¼Œæ”¯æ´ JPG/PNG/GIFï¼‰</label>
          <input
            id="imageInput"
            type="url"
            placeholder="è²¼ä¸Š IG / Google ç›¸ç°¿ / ç¶²è·¯ç…§ç‰‡é€£çµ"
          />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelBtn">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="saveBtn" disabled>å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- åŒ¯å‡º / åŒ¯å…¥ Modal -->
  <div class="modal-backdrop-io" id="ioBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h2 id="ioTitle">åŒ¯å‡ºè¡Œç¨‹</h2>
        <button class="modal-close" id="ioCloseBtn">&times;</button>
      </div>
      <div class="modal-body" id="ioBody">
        <!-- JS ä¾æ¨¡å¼å¡«å…¥å…§å®¹ -->
      </div>
      <div class="modal-footer" id="ioFooter">
        <!-- JS ä¾æ¨¡å¼å¡«å…¥æŒ‰éˆ• -->
      </div>
    </div>
  </div>

  <script>
    // --- åŸºæœ¬è¨­å®š ---
    const DAYS = ["Day 1", "Day 2", "Day 3", "Day 4", "Day 5", "Day 6"];
    const STORAGE_KEY = "hokkaidoTripBoard_v3"; // æ–°ç‰ˆæœ¬ key

    const boardEl = document.getElementById("board");

    // æ–°å¢æ™¯é» modal å…ƒä»¶
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalCloseBtn = document.getElementById("modalCloseBtn");
    const daySelect = document.getElementById("daySelect");
    const titleInput = document.getElementById("titleInput");
    const timeInput = document.getElementById("timeInput");
    const noteInput = document.getElementById("noteInput");
    const mapInput = document.getElementById("mapInput");
    const imageInput = document.getElementById("imageInput");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");

    // åŒ¯å‡º / åŒ¯å…¥ modal å…ƒä»¶
    const ioBackdrop = document.getElementById("ioBackdrop");
    const ioTitle = document.getElementById("ioTitle");
    const ioBody = document.getElementById("ioBody");
    const ioFooter = document.getElementById("ioFooter");
    const ioCloseBtn = document.getElementById("ioCloseBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");

    let state = {}; // { "Day 1": [ {title, time, note, imageUrl, mapQuery}, ... ], ... }
    let currentDayForAdd = "Day 1";

    // --- åˆå§‹åŒ– ---
    function init() {
      // Day é¸å–®
      DAYS.forEach((day) => {
        const option = document.createElement("option");
        option.value = day;
        option.textContent = day;
        daySelect.appendChild(option);
      });

      // å¾ localStorage è¼‰å…¥
      const raw = window.localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          DAYS.forEach((d) => {
            if (!parsed[d]) parsed[d] = [];
          });
          state = parsed;
        } catch (e) {
          state = createEmptyState();
        }
      } else {
        state = createEmptyState();
      }

      renderBoard();
      bindEvents();
    }

    function createEmptyState() {
      const obj = {};
      DAYS.forEach((day) => {
        obj[day] = [];
      });
      return obj;
    }

    // --- ç•«é¢æ¸²æŸ“ ---
    function renderBoard() {
      boardEl.innerHTML = "";
      DAYS.forEach((day) => {
        const column = document.createElement("section");
        column.className = "day-column";
        column.dataset.day = day;

        const header = document.createElement("div");
        header.className = "day-header";
        const title = document.createElement("div");
        title.className = "day-title";
        title.textContent = day;
        const date = document.createElement("div");
        date.className = "day-date";
        date.textContent = ""; // éœ€è¦çš„è©±å¯ä»¥å¡«å¯¦éš›æ—¥æœŸ
        header.appendChild(title);
        header.appendChild(date);

        const cardList = document.createElement("div");
        cardList.className = "card-list";

        const cards = state[day] || [];
        cards.forEach((card, index) => {
          const cardEl = createCardElement(card, day, index);
          cardList.appendChild(cardEl);
        });

        const addBtn = document.createElement("button");
        addBtn.className = "add-btn";
        addBtn.type = "button";
        addBtn.textContent = "ï¼‹ æ–°å¢æ™¯é»";
        addBtn.addEventListener("click", () => openAddModal(day));

        column.appendChild(header);
        column.appendChild(cardList);
        column.appendChild(addBtn);
        boardEl.appendChild(column);
      });
    }

    function createCardElement(card, day, index) {
      const cardEl = document.createElement("div");
      cardEl.className = "card";
      cardEl.dataset.day = day;
      cardEl.dataset.index = index.toString();

      if (card.imageUrl) {
        const img = document.createElement("img");
        img.src = card.imageUrl;
        img.alt = card.title || "ç…§ç‰‡";
        cardEl.appendChild(img);
      }

      const content = document.createElement("div");
      content.className = "card-content";

      const titleRow = document.createElement("div");
      titleRow.className = "card-title-row";

      const title = document.createElement("div");
      title.className = "card-title";
      title.textContent = card.title || "";

      const time = document.createElement("div");
      time.className = "card-time";
      time.textContent = card.time || "";

      titleRow.appendChild(title);
      titleRow.appendChild(time);

      const note = document.createElement("div");
      note.className = "card-note";
      note.textContent = card.note || "";

      content.appendChild(titleRow);
      content.appendChild(note);

      // footer: Google Maps æŒ‰éˆ•
      const mapUrl = buildMapUrl(card);
      if (mapUrl) {
        const footer = document.createElement("div");
        footer.className = "card-footer";

        const mapLink = document.createElement("a");
        mapLink.href = mapUrl;
        mapLink.target = "_blank";
        mapLink.rel = "noopener noreferrer";
        mapLink.className = "map-link-btn";
        mapLink.innerHTML = '<span>ğŸ“</span> åœ¨ Google åœ°åœ–é–‹å•Ÿ';

        footer.appendChild(mapLink);
        content.appendChild(footer);
      }

      const delBtn = document.createElement("button");
      delBtn.className = "card-delete";
      delBtn.type = "button";
      delBtn.innerHTML = "&times;";
      delBtn.addEventListener("click", () => deleteCard(day, index));

      cardEl.appendChild(content);
      cardEl.appendChild(delBtn);
      return cardEl;
    }

    // å»ºç«‹ Google Maps URL
    function buildMapUrl(card) {
      const raw = (card.mapQuery || "").trim();
      const fallbackQuery = (card.title || "").trim();

      let query = raw || fallbackQuery;
      if (!query) return "";

      if (query.startsWith("http://") || query.startsWith("https://")) {
        return query;
      }

      const encoded = encodeURIComponent(query);
      return `https://www.google.com/maps/search/?api=1&query=${encoded}`;
    }

    // --- æ–°å¢æ™¯é» Modal æ§åˆ¶ ---
    function openAddModal(day) {
      currentDayForAdd = day;
      daySelect.value = day;
      titleInput.value = "";
      timeInput.value = "";
      noteInput.value = "";
      mapInput.value = "";
      imageInput.value = "";
      saveBtn.disabled = true;
      modalBackdrop.classList.add("show");
      titleInput.focus();
    }

    function closeAddModal() {
      modalBackdrop.classList.remove("show");
    }

    // --- åŒ¯å‡º / åŒ¯å…¥ Modal æ§åˆ¶ ---
    function openExportModal() {
      ioTitle.textContent = "åŒ¯å‡ºè¡Œç¨‹";
      ioBody.innerHTML = "";
      ioFooter.innerHTML = "";

      const textarea = document.createElement("textarea");
      textarea.className = "io-textarea";
      textarea.id = "exportTextarea";
      textarea.readOnly = false; // æ–¹ä¾¿é¸å–
      textarea.value = JSON.stringify(state);

      const helper = document.createElement("div");
      helper.className = "io-helper";
      helper.textContent =
        "æ­¥é©Ÿï¼š1ï¼‰æŒ‰ã€Œå…¨é¸ä¸¦è¤‡è£½ã€ï¼Œæˆ–è‡ªå·±å…¨é¸è¤‡è£½ 2ï¼‰è²¼åˆ° LINE/Notion å‚³åˆ°æ‰‹æ©Ÿ 3ï¼‰åœ¨æ‰‹æ©Ÿé é¢æŒ‰ã€ŒåŒ¯å…¥è¡Œç¨‹ã€è²¼ä¸Šã€‚";

      ioBody.appendChild(textarea);
      ioBody.appendChild(helper);

      const closeBtn = document.createElement("button");
      closeBtn.className = "btn btn-secondary";
      closeBtn.textContent = "é—œé–‰";
      closeBtn.type = "button";
      closeBtn.addEventListener("click", closeIoModal);

      const copyBtn = document.createElement("button");
      copyBtn.className = "btn btn-primary";
      copyBtn.textContent = "å…¨é¸ä¸¦è¤‡è£½";
      copyBtn.type = "button";
      copyBtn.addEventListener("click", () => {
        textarea.focus();
        textarea.select();
        try {
          document.execCommand("copy");
          copyBtn.textContent = "å·²è¤‡è£½";
          setTimeout(() => {
            copyBtn.textContent = "å…¨é¸ä¸¦è¤‡è£½";
          }, 1500);
        } catch (e) {
          alert("è¤‡è£½å¤±æ•—ï¼Œå¯ä»¥æ‰‹å‹•é•·æŒ‰é¸å–å…§å®¹å¾Œè¤‡è£½ã€‚");
        }
      });

      ioFooter.appendChild(closeBtn);
      ioFooter.appendChild(copyBtn);

      ioBackdrop.classList.add("show");
      textarea.focus();
      textarea.select();
    }

    function openImportModal() {
      ioTitle.textContent = "åŒ¯å…¥è¡Œç¨‹";
      ioBody.innerHTML = "";
      ioFooter.innerHTML = "";

      const textarea = document.createElement("textarea");
      textarea.className = "io-textarea";
      textarea.id = "importTextarea";
      textarea.placeholder =
        "è«‹è²¼ä¸Šå¾ã€ŒåŒ¯å‡ºè¡Œç¨‹ã€è¤‡è£½çš„é‚£æ®µæ–‡å­—ï¼ˆJSONï¼‰ã€‚\nè²¼å¥½å¾ŒæŒ‰ã€Œå¥—ç”¨è¡Œç¨‹ã€ã€‚";

      const helper = document.createElement("div");
      helper.className = "io-helper";
      helper.textContent =
        "æ³¨æ„ï¼šåŒ¯å…¥å¾Œæœƒè¦†è“‹ç›®å‰é€™å°è£ç½®ä¸Šçš„è¡Œç¨‹è³‡æ–™ï¼ˆDay1ï½Day6ï¼‰ã€‚å¦‚æœè¦ä¿ç•™ç¾åœ¨çš„ï¼Œå¯ä»¥å…ˆæŒ‰ã€ŒåŒ¯å‡ºè¡Œç¨‹ã€å‚™ä»½ã€‚";

      ioBody.appendChild(textarea);
      ioBody.appendChild(helper);

      const cancelBtn = document.createElement("button");
      cancelBtn.className = "btn btn-secondary";
      cancelBtn.textContent = "å–æ¶ˆ";
      cancelBtn.type = "button";
      cancelBtn.addEventListener("click", closeIoModal);

      const applyBtn = document.createElement("button");
      applyBtn.className = "btn btn-primary";
      applyBtn.textContent = "å¥—ç”¨è¡Œç¨‹";
      applyBtn.type = "button";
      applyBtn.addEventListener("click", () => {
        const text = textarea.value.trim();
        if (!text) {
          alert("è«‹å…ˆè²¼ä¸ŠåŒ¯å‡ºçš„æ–‡å­—ã€‚");
          return;
        }

        try {
          const parsed = JSON.parse(text);
          const normalized = normalizeState(parsed);
          state = normalized;
          persistState();
          renderBoard();
          closeIoModal();
          alert("åŒ¯å…¥å®Œæˆï¼Œç¾åœ¨é€™å°è£ç½®å·²å¥—ç”¨æ–°çš„è¡Œç¨‹ã€‚");
        } catch (e) {
          alert("åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼ä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œæˆ–å…§å®¹çµæ§‹ä¸æ­£ç¢ºã€‚è«‹ç¢ºèªè²¼ä¸Šçš„æ˜¯åŸæœ¬åŒ¯å‡ºçš„æ–‡å­—ã€‚");
        }
      });

      ioFooter.appendChild(cancelBtn);
      ioFooter.appendChild(applyBtn);

      ioBackdrop.classList.add("show");
      textarea.focus();
    }

    function closeIoModal() {
      ioBackdrop.classList.remove("show");
    }

    // è®“èˆŠåŒ¯å‡ºè³‡æ–™ä¹Ÿèƒ½ç”¨ï¼ˆåªè¦é•·å¾—åƒ {day:[...]} å°±æ•´ç†ï¼‰
    function normalizeState(rawObj) {
      const obj = createEmptyState();
      if (typeof rawObj !== "object" || rawObj === null) return obj;

      DAYS.forEach((day) => {
        if (Array.isArray(rawObj[day])) {
          obj[day] = rawObj[day].map((item) => ({
            title: (item.title || "").toString(),
            time: (item.time || "").toString(),
            note: (item.note || "").toString(),
            mapQuery: (item.mapQuery || "").toString(),
            imageUrl: (item.imageUrl || "").toString(),
          }));
        }
      });

      return obj;
    }

    // --- äº‹ä»¶ ---
    function bindEvents() {
      // æ–°å¢æ™¯é» modal
      modalCloseBtn.addEventListener("click", closeAddModal);
      cancelBtn.addEventListener("click", closeAddModal);

      modalBackdrop.addEventListener("click", (e) => {
        if (e.target === modalBackdrop) {
          closeAddModal();
        }
      });

      titleInput.addEventListener("input", () => {
        saveBtn.disabled = titleInput.value.trim() === "";
      });

      saveBtn.addEventListener("click", () => {
        const title = titleInput.value.trim();
        if (!title) return;

        const card = {
          title,
          time: timeInput.value.trim(),
          note: noteInput.value.trim(),
          mapQuery: mapInput.value.trim(),
          imageUrl: imageInput.value.trim(),
        };

        const day = daySelect.value || currentDayForAdd;
        state[day].push(card);
        persistState();
        renderBoard();
        closeAddModal();
      });

      // åŒ¯å‡º / åŒ¯å…¥ modal
      ioCloseBtn.addEventListener("click", closeIoModal);
      ioBackdrop.addEventListener("click", (e) => {
        if (e.target === ioBackdrop) {
          closeIoModal();
        }
      });

      exportBtn.addEventListener("click", openExportModal);
      importBtn.addEventListener("click", openImportModal);
    }

    // --- åˆªé™¤å¡ç‰‡ ---
    function deleteCard(day, index) {
      if (!Array.isArray(state[day])) return;
      state[day].splice(index, 1);
      persistState();
      renderBoard();
    }

    // --- å„²å­˜ ---
    function persistState() {
      window.localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // å•Ÿå‹•
    init();
  </script>
</body>
</html>
